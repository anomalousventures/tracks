# Epic 2.2: Goose Migration System

[← Back to Phase 2](../2-data-layer.md) | [← Epic 2.1](./2.1-identifier-utilities.md)

**Status:** Not Started

## Overview

Implement database migration infrastructure using Goose with embedded migrations and driver-specific SQL schemas. This epic creates the foundation for database schema management in generated projects, supporting SQLite/go-libsql and PostgreSQL with separate migration directories.

## Goals

- Migration directory structure per database driver
- Migration runner with embedded FS support
- Initial schema migration template (minimal schema for health check)
- Makefile targets for migration management
- Driver-specific SQL patterns (triggers, timestamps)

## Scope

### In Scope

- `internal/db/migrations/sqlite/` directory structure
- `internal/db/migrations/postgres/` directory structure
- `internal/db/migrate.go` template with embedded migrations
- Initial schema migration (00001_initial_schema.sql) for each driver
- Makefile targets: migrate-up, migrate-down, migrate-status, migrate-create
- Driver detection and dialect selection
- Migration embedding via embed.FS

### Out of Scope

- `tracks db` CLI commands (Epic 2.4)
- Complex schema examples (Phase 4)
- Seed data (Phase 4)
- Migration rollback testing in CI (added to E2E workflow)

## GitHub Issues

| Issue | Title | Scope |
|-------|-------|-------|
| [#522](https://github.com/anomalousventures/tracks/issues/522) | Migration runner and directory structure | Core infrastructure, embed.FS, ProjectGenerator wiring |
| [#523](https://github.com/anomalousventures/tracks/issues/523) | Initial schema migrations (SQLite & PostgreSQL) | Driver-specific SQL, Goose annotations, triggers |
| [#524](https://github.com/anomalousventures/tracks/issues/524) | Migration Makefile targets | migrate-up, migrate-down, migrate-status, migrate-create |
| [#525](https://github.com/anomalousventures/tracks/issues/525) | Migration end-to-end integration tests | E2E validation for all drivers |

## Dependencies

### Prerequisites

- Epic 2.1 completed (UUIDv7 for ID columns)
- Phase 1 completed (project generation working)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/pressly/goose/v3` - Already in go.mod template
- Database drivers (already in go.mod template)

### Blocks

- Epic 2.3 (SQLC Enhancement) - SQLC needs schema from migrations
- Epic 2.4 (Database CLI) - CLI wraps migration runner

## Acceptance Criteria

### Templates Created

- [ ] `internal/templates/project/internal/db/migrate.go.tmpl` exists
- [ ] `internal/templates/project/internal/db/migrations/sqlite/00001_initial_schema.sql.tmpl` exists
- [ ] `internal/templates/project/internal/db/migrations/postgres/00001_initial_schema.sql.tmpl` exists
- [ ] Migration embedding template exists
- [ ] All templates use Go template syntax correctly

### Migration Runner Functions

- [ ] `MigrateUp()` applies all pending migrations
- [ ] `MigrateDown()` rolls back last migration
- [ ] `MigrateStatus()` returns list of applied/pending migrations
- [ ] `MigrateTo(version)` migrates to specific version
- [ ] Driver detection works for all 3 drivers

### Makefile Targets

- [ ] `make migrate-up` runs all pending migrations
- [ ] `make migrate-down` rolls back last migration
- [ ] `make migrate-status` shows migration status
- [ ] `make migrate-create NAME=add_users` creates timestamped file
- [ ] Targets use correct driver-specific directory

### Migration SQL Quality

- [ ] Migrations use proper Goose annotations (+goose Up, +goose Down)
- [ ] SQLite migrations use appropriate triggers
- [ ] PostgreSQL migrations use TIMESTAMPTZ
- [ ] ID columns use TEXT for UUIDs
- [ ] All migrations are reversible (have Down section)

### Generator Integration

- [ ] ProjectGenerator renders migrate.go to `internal/db/`
- [ ] ProjectGenerator renders correct migrations based on DBDriver
- [ ] ProjectGenerator creates migrations directories
- [ ] Fresh generated project can run `make migrate-up`

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify migrations run on sqlite3
- [ ] Integration tests verify migrations run on postgres
- [ ] Integration tests verify rollback works
- [ ] All tests pass in CI

## Technical Notes

### Migration File Naming

Format: `YYYYMMDDHHMMSS_description.sql`
Example: `20250128143022_create_users.sql`

### Goose Annotations

```sql
-- +goose Up
-- +goose StatementBegin
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
DROP TABLE IF EXISTS users;
-- +goose StatementEnd
```

### SQLite updated_at Trigger Pattern

```sql
CREATE TRIGGER trg_users_updated_at
AFTER UPDATE ON users
FOR EACH ROW
BEGIN
    UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

### PostgreSQL updated_at Function Pattern

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### Driver to Dialect Mapping

| Driver | Goose Dialect |
|--------|---------------|
| go-libsql | sqlite3 |
| sqlite3 | sqlite3 |
| postgres | postgres |

### Embedded Migrations

```go
//go:embed migrations/sqlite/*.sql
var sqliteMigrations embed.FS

//go:embed migrations/postgres/*.sql
var postgresMigrations embed.FS

func GetMigrations(driver string) fs.FS {
    switch driver {
    case "postgres":
        return postgresMigrations
    default:
        return sqliteMigrations
    }
}
```

## Next Epic

[Epic 2.3: SQLC Enhancement →](./2.3-sqlc-enhancement.md)

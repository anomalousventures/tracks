# Epic 2.2: Goose Migration System

[← Back to Phase 2](../2-data-layer.md) | [← Epic 2.1](./2.1-identifier-utilities.md)

**Status:** Not Started

## Overview

Implement database migration infrastructure using Goose with embedded migrations and driver-specific SQL schemas. This epic creates the foundation for database schema management in generated projects, supporting SQLite/go-libsql and PostgreSQL with separate migration directories.

## Goals

- Migration directory structure per database driver
- Migration runner with embedded FS support
- Initial schema migration template (minimal schema for health check)
- Makefile targets for migration management
- Driver-specific SQL patterns (triggers, timestamps)

## Scope

### In Scope

- `internal/db/migrations/sqlite/` directory structure
- `internal/db/migrations/postgres/` directory structure
- `internal/db/migrate.go` template with embedded migrations
- Initial schema migration (00001_initial_schema.sql) for each driver
- Makefile targets: migrate-up, migrate-down, migrate-status, migrate-create
- Driver detection and dialect selection
- Migration embedding via embed.FS

### Out of Scope

- `tracks db` CLI commands (Epic 2.4)
- Complex schema examples (Phase 4)
- Seed data (Phase 4)
- Migration rollback testing in CI (added to E2E workflow)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Directory Structure Templates (Tasks 1-4)

1. Create `internal/db/migrations/sqlite/.gitkeep.tmpl` for directory preservation
2. Create `internal/db/migrations/postgres/.gitkeep.tmpl` for directory preservation
3. Update ProjectGenerator to create migrations directories based on driver
4. Add embed.go template for migrations embedding

### Phase 2: Migration Runner Template (Tasks 5-10)

1. Create `internal/db/migrate.go.tmpl` with Goose setup and dialect detection
2. Add MigrateUp function with embedded FS support
3. Add MigrateDown function for rollback
4. Add MigrateStatus function for status reporting
5. Add MigrateTo function for targeting specific version
6. Add migration runner tests template

### Phase 3: Initial Schema Migrations (Tasks 11-16)

1. Create SQLite initial migration: `00001_initial_schema.sql.tmpl` (goose_db_version table, updated_at trigger pattern)
2. Create PostgreSQL initial migration: `00001_initial_schema.sql.tmpl` (goose_db_version table, updated_at function)
3. Add UUIDv7 column patterns to migration templates
4. Add TEXT-based UUID storage pattern
5. Add TIMESTAMPTZ vs TIMESTAMP patterns per driver
6. Test migration templates render valid SQL

### Phase 4: Makefile Integration (Tasks 17-22)

1. Add `migrate-up` target to Makefile.tmpl
2. Add `migrate-down` target to Makefile.tmpl
3. Add `migrate-status` target to Makefile.tmpl
4. Add `migrate-create` target to Makefile.tmpl (generates timestamped file)
5. Add `migrate-reset` target to Makefile.tmpl (dangerous, requires confirmation)
6. Wire migration targets to use correct driver-specific directory

### Phase 5: ProjectGenerator Integration (Tasks 23-27)

1. Wire migrate.go template into ProjectGenerator
2. Wire migration directory templates based on DBDriver
3. Wire initial schema migration based on DBDriver
4. Add migrations to pre-generate template list
5. Test that `make migrate-up` works on fresh generated project

### Phase 6: Testing & Validation (Tasks 28-32)

1. Template rendering tests for migrate.go
2. Template rendering tests for SQLite migrations
3. Template rendering tests for PostgreSQL migrations
4. Integration test: migrations run successfully on sqlite3
5. Integration test: migrations run successfully on postgres (requires Docker)

## Dependencies

### Prerequisites

- Epic 2.1 completed (UUIDv7 for ID columns)
- Phase 1 completed (project generation working)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/pressly/goose/v3` - Already in go.mod template
- Database drivers (already in go.mod template)

### Blocks

- Epic 2.3 (SQLC Enhancement) - SQLC needs schema from migrations
- Epic 2.4 (Database CLI) - CLI wraps migration runner

## Acceptance Criteria

### Templates Created

- [ ] `internal/templates/project/internal/db/migrate.go.tmpl` exists
- [ ] `internal/templates/project/internal/db/migrations/sqlite/00001_initial_schema.sql.tmpl` exists
- [ ] `internal/templates/project/internal/db/migrations/postgres/00001_initial_schema.sql.tmpl` exists
- [ ] Migration embedding template exists
- [ ] All templates use Go template syntax correctly

### Migration Runner Functions

- [ ] `MigrateUp()` applies all pending migrations
- [ ] `MigrateDown()` rolls back last migration
- [ ] `MigrateStatus()` returns list of applied/pending migrations
- [ ] `MigrateTo(version)` migrates to specific version
- [ ] Driver detection works for all 3 drivers

### Makefile Targets

- [ ] `make migrate-up` runs all pending migrations
- [ ] `make migrate-down` rolls back last migration
- [ ] `make migrate-status` shows migration status
- [ ] `make migrate-create NAME=add_users` creates timestamped file
- [ ] Targets use correct driver-specific directory

### Migration SQL Quality

- [ ] Migrations use proper Goose annotations (+goose Up, +goose Down)
- [ ] SQLite migrations use appropriate triggers
- [ ] PostgreSQL migrations use TIMESTAMPTZ
- [ ] ID columns use TEXT for UUIDs
- [ ] All migrations are reversible (have Down section)

### Generator Integration

- [ ] ProjectGenerator renders migrate.go to `internal/db/`
- [ ] ProjectGenerator renders correct migrations based on DBDriver
- [ ] ProjectGenerator creates migrations directories
- [ ] Fresh generated project can run `make migrate-up`

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify migrations run on sqlite3
- [ ] Integration tests verify migrations run on postgres
- [ ] Integration tests verify rollback works
- [ ] All tests pass in CI

## Technical Notes

### Migration File Naming

Format: `YYYYMMDDHHMMSS_description.sql`
Example: `20250128143022_create_users.sql`

### Goose Annotations

```sql
-- +goose Up
-- +goose StatementBegin
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
DROP TABLE IF EXISTS users;
-- +goose StatementEnd
```

### SQLite updated_at Trigger Pattern

```sql
CREATE TRIGGER trg_users_updated_at
AFTER UPDATE ON users
FOR EACH ROW
BEGIN
    UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

### PostgreSQL updated_at Function Pattern

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### Driver to Dialect Mapping

| Driver | Goose Dialect |
|--------|---------------|
| go-libsql | sqlite3 |
| sqlite3 | sqlite3 |
| postgres | postgres |

### Embedded Migrations

```go
//go:embed migrations/sqlite/*.sql
var sqliteMigrations embed.FS

//go:embed migrations/postgres/*.sql
var postgresMigrations embed.FS

func GetMigrations(driver string) fs.FS {
    switch driver {
    case "postgres":
        return postgresMigrations
    default:
        return sqliteMigrations
    }
}
```

## Next Epic

[Epic 2.3: SQLC Enhancement →](./2.3-sqlc-enhancement.md)

# Epic 2.3: SQLC Query Enhancement

[← Back to Phase 2](../../2-data-layer.md) | [← Epic 2.2](./2.2-goose-migrations.md)

**Status:** Not Started

## Overview

Enhance the existing SQLC configuration to work correctly with all three database drivers, ensure proper type mappings, and verify that query generation is idempotent. This epic audits and updates the existing sqlc.yaml template and health check query to ensure robust type-safe SQL generation.

## Goals

- Audit and fix sqlc.yaml.tmpl for all drivers
- Ensure health check query works with all drivers
- Verify `make generate` produces valid Go code
- Ensure SQLC generation is idempotent
- Document query patterns for developers

## Scope

### In Scope

- Audit sqlc.yaml.tmpl against PRD specifications
- Fix driver-to-engine mapping (go-libsql/sqlite3 → sqlite, postgres → postgresql)
- Update health.sql.tmpl for driver-specific parameter syntax
- Add type overrides for common patterns
- Verify `make generate` includes SQLC correctly
- Add .gitkeep for generated directory
- Add inline documentation for query patterns
- Template rendering tests

### Out of Scope

- Example CRUD queries beyond health check (Phase 4)
- Repository implementations beyond health (Phase 4)
- Query optimization guidance (documentation epic)
- Complex JOIN patterns (Phase 4)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Audit Existing Templates (Tasks 1-4)

1. Audit sqlc.yaml.tmpl against PRD specifications
2. Document gaps between current template and PRD requirements
3. Audit health.sql.tmpl for driver compatibility
4. Document any driver-specific SQL issues

### Phase 2: SQLC Configuration Fixes (Tasks 5-10)

1. Fix engine mapping in sqlc.yaml.tmpl (sqlite vs postgresql)
2. Update schema path to use driver-specific migrations directory
3. Add emit_json_tags configuration
4. Add emit_interface configuration for testing
5. Add emit_empty_slices configuration
6. Add type overrides for TEXT → string mapping

### Phase 3: Query Template Updates (Tasks 11-14)

1. Update health.sql.tmpl with proper SQLC annotations
2. Add driver-conditional parameter syntax (? vs $1)
3. Create `internal/db/generated/.gitkeep.tmpl` placeholder
4. Add inline comments documenting query patterns

### Phase 4: Makefile Verification (Tasks 15-17)

1. Verify `make generate` includes sqlc target in correct order
2. Verify sqlc runs after migrations directory exists
3. Add `make sqlc` standalone target if not present

### Phase 5: Testing & Validation (Tasks 18-22)

1. Template rendering tests for sqlc.yaml with sqlite3 driver
2. Template rendering tests for sqlc.yaml with postgres driver
3. Template rendering tests for health.sql
4. Integration test: SQLC generates valid Go for sqlite3
5. Integration test: SQLC generates valid Go for postgres

### Phase 6: Idempotency Verification (Tasks 23-25)

1. Test that running `make generate` twice produces identical output
2. Add CI check for SQLC generation idempotency
3. Document any known non-idempotent scenarios

## Dependencies

### Prerequisites

- Epic 2.2 completed (migrations provide schema for SQLC)
- Phase 1 completed (project generation working)

### External Dependencies

- sqlc (already a tool dependency)

### Blocks

- Epic 2.4 (Database CLI) - Can proceed in parallel
- Phase 4 (Code Generation) - Full CRUD queries depend on this

## Acceptance Criteria

### Template Quality

- [ ] sqlc.yaml.tmpl matches PRD specifications
- [ ] Engine correctly maps: go-libsql/sqlite3 → sqlite, postgres → postgresql
- [ ] Schema path uses correct driver-specific directory
- [ ] All recommended emit_* options configured

### Query Compatibility

- [ ] health.sql works with sqlite3 driver
- [ ] health.sql works with go-libsql driver
- [ ] health.sql works with postgres driver
- [ ] Parameter syntax is correct per driver

### Generated Code Quality

- [ ] `make generate` produces valid Go code
- [ ] Generated code compiles without errors
- [ ] Generated interfaces exist for testing
- [ ] JSON tags present on structs
- [ ] Empty slices returned instead of nil

### Idempotency

- [ ] Running `make generate` twice produces identical output
- [ ] No git diff after re-running generation
- [ ] CI verifies idempotency

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify SQLC generates valid Go
- [ ] All tests pass in CI

## Technical Notes

### sqlc.yaml Configuration

```yaml
version: "2"
sql:
  - engine: "{{if eq .DBDriver "postgres"}}postgresql{{else}}sqlite{{end}}"
    queries: "internal/db/queries"
    schema: "internal/db/migrations/{{if eq .DBDriver "postgres"}}postgres{{else}}sqlite{{end}}"
    gen:
      go:
        package: "generated"
        out: "internal/db/generated"
        emit_json_tags: true
        emit_interface: true
        emit_empty_slices: true
```

### Parameter Syntax by Driver

| Driver | Syntax | Example |
|--------|--------|---------|
| sqlite/go-libsql | ? | `WHERE id = ?` |
| postgres | $N | `WHERE id = $1` |

### SQLC Query Annotations

```sql
-- name: GetUserByID :one
SELECT * FROM users WHERE id = ? LIMIT 1;

-- name: ListUsers :many
SELECT * FROM users ORDER BY created_at DESC LIMIT ? OFFSET ?;

-- name: CreateUser :one
INSERT INTO users (id, email, created_at) VALUES (?, ?, ?) RETURNING *;

-- name: DeleteUser :exec
DELETE FROM users WHERE id = ?;
```

### Generated Interface Pattern

```go
type Querier interface {
    GetUserByID(ctx context.Context, id string) (User, error)
    ListUsers(ctx context.Context, arg ListUsersParams) ([]User, error)
    CreateUser(ctx context.Context, arg CreateUserParams) (User, error)
    DeleteUser(ctx context.Context, id string) error
}
```

### Health Check Query

```sql
-- name: HealthCheck :one
-- Verifies database connectivity
SELECT 1 as healthy;
```

## Next Epic

[Epic 2.4: Database CLI Commands →](./2.4-database-cli.md)

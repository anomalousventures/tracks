# Epic 2.3: SQLC Query Enhancement

[← Back to Phase 2](../2-data-layer.md) | [← Epic 2.2](./2.2-goose-migrations.md)

**Status:** Not Started

## Overview

Enhance the existing SQLC configuration to work correctly with all three database drivers, ensure proper type mappings, and verify that query generation is idempotent. This epic audits and updates the existing sqlc.yaml template and health check query to ensure robust type-safe SQL generation.

## Goals

- Audit and fix sqlc.yaml.tmpl for all drivers
- Ensure health check query works with all drivers
- Verify `make generate` produces valid Go code
- Ensure SQLC generation is idempotent
- Document query patterns for developers

## Scope

### In Scope

- Audit sqlc.yaml.tmpl against PRD specifications
- Fix driver-to-engine mapping (go-libsql/sqlite3 → sqlite, postgres → postgresql)
- Update health.sql.tmpl for driver-specific parameter syntax
- Add type overrides for common patterns
- Verify `make generate` includes SQLC correctly
- Add .gitkeep for generated directory
- Add inline documentation for query patterns
- Template rendering tests

### Out of Scope

- Example CRUD queries beyond health check (Phase 4)
- Repository implementations beyond health (Phase 4)
- Query optimization guidance (documentation epic)
- Complex JOIN patterns (Phase 4)

## GitHub Issues

| Issue | Title | Scope |
|-------|-------|-------|
| [#526](https://github.com/anomalousventures/tracks/issues/526) | SQLC configuration audit and fix | Engine mapping, emit options, type overrides |
| [#527](https://github.com/anomalousventures/tracks/issues/527) | Health check query and generated code | Query templates, parameter syntax, Makefile |
| [#528](https://github.com/anomalousventures/tracks/issues/528) | SQLC integration and idempotency tests | E2E validation, idempotency verification |

## Dependencies

### Prerequisites

- Epic 2.2 completed (migrations provide schema for SQLC)
- Phase 1 completed (project generation working)

### External Dependencies

- sqlc (already a tool dependency)

### Blocks

- Epic 2.4 (Database CLI) - Can proceed in parallel
- Phase 4 (Code Generation) - Full CRUD queries depend on this

## Acceptance Criteria

### Template Quality

- [ ] sqlc.yaml.tmpl matches PRD specifications
- [ ] Engine correctly maps: go-libsql/sqlite3 → sqlite, postgres → postgresql
- [ ] Schema path uses correct driver-specific directory
- [ ] All recommended emit_* options configured

### Query Compatibility

- [ ] health.sql works with sqlite3 driver
- [ ] health.sql works with go-libsql driver
- [ ] health.sql works with postgres driver
- [ ] Parameter syntax is correct per driver

### Generated Code Quality

- [ ] `make generate` produces valid Go code
- [ ] Generated code compiles without errors
- [ ] Generated interfaces exist for testing
- [ ] JSON tags present on structs
- [ ] Empty slices returned instead of nil

### Idempotency

- [ ] Running `make generate` twice produces identical output
- [ ] No git diff after re-running generation
- [ ] CI verifies idempotency

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify SQLC generates valid Go
- [ ] All tests pass in CI

## Technical Notes

### sqlc.yaml Configuration

```yaml
version: "2"
sql:
  - engine: "{{if eq .DBDriver "postgres"}}postgresql{{else}}sqlite{{end}}"
    queries: "internal/db/queries"
    schema: "internal/db/migrations/{{if eq .DBDriver "postgres"}}postgres{{else}}sqlite{{end}}"
    gen:
      go:
        package: "generated"
        out: "internal/db/generated"
        emit_json_tags: true
        emit_interface: true
        emit_empty_slices: true
```

### Parameter Syntax by Driver

| Driver | Syntax | Example |
|--------|--------|---------|
| sqlite/go-libsql | ? | `WHERE id = ?` |
| postgres | $N | `WHERE id = $1` |

### SQLC Query Annotations

```sql
-- name: GetUserByID :one
SELECT * FROM users WHERE id = ? LIMIT 1;

-- name: ListUsers :many
SELECT * FROM users ORDER BY created_at DESC LIMIT ? OFFSET ?;

-- name: CreateUser :one
INSERT INTO users (id, email, created_at) VALUES (?, ?, ?) RETURNING *;

-- name: DeleteUser :exec
DELETE FROM users WHERE id = ?;
```

### Generated Interface Pattern

```go
type Querier interface {
    GetUserByID(ctx context.Context, id string) (User, error)
    ListUsers(ctx context.Context, arg ListUsersParams) ([]User, error)
    CreateUser(ctx context.Context, arg CreateUserParams) (User, error)
    DeleteUser(ctx context.Context, id string) error
}
```

### Health Check Query

```sql
-- name: HealthCheck :one
-- Verifies database connectivity
SELECT 1 as healthy;
```

## Next Epic

[Epic 2.4: Database CLI Commands →](./2.4-database-cli.md)

# Epic 2.4: Database CLI Commands

[← Back to Phase 2](../../2-data-layer.md) | [← Epic 2.3](./2.3-sqlc-enhancement.md)

**Status:** Not Started

## Overview

Add `tracks db` subcommands to the Tracks CLI for database management. These commands allow developers to manage migrations, check database status, and reset databases from the command line when working in a Tracks project directory.

## Goals

- `tracks db migrate` command for running migrations
- `tracks db rollback` command for rolling back migrations
- `tracks db status` command for checking migration status
- `tracks db reset` command for resetting the database
- Commands work with all 3 database drivers
- Commands read configuration from project .env or environment

## Scope

### In Scope

- Parent `db` command with subcommands
- `tracks db migrate` with --steps and --dry-run flags
- `tracks db rollback` with --steps flag
- `tracks db status` (no flags)
- `tracks db reset` with --force flag (requires confirmation without)
- Read DATABASE_URL from .env or environment
- Detect project directory via .tracks.yaml
- Interface-based design for testability
- Unit tests for all commands
- Integration tests with generated projects

### Out of Scope

- `tracks db seed` (Phase 4 with example data)
- `tracks db console` (interactive SQL shell)
- `tracks db create` (database creation)
- `tracks db drop` (database deletion outside reset)
- Remote database management

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Command Structure (Tasks 1-5)

1. Create `internal/cli/commands/db.go` with parent db command
2. Add db command to root command registration
3. Create DatabaseManager interface in `internal/cli/interfaces/database.go`
4. Create project detection helper (find .tracks.yaml, read config)
5. Create database connection helper (read .env, connect to database)

### Phase 2: Migrate Command (Tasks 6-10)

1. Create `internal/cli/commands/db_migrate.go` with basic structure
2. Implement `tracks db migrate` to run all pending migrations
3. Add --steps flag to limit number of migrations
4. Add --dry-run flag to show what would be migrated
5. Add migrate command tests

### Phase 3: Rollback Command (Tasks 11-14)

1. Create `internal/cli/commands/db_rollback.go` with basic structure
2. Implement `tracks db rollback` to roll back last migration
3. Add --steps flag to roll back multiple migrations
4. Add rollback command tests

### Phase 4: Status Command (Tasks 15-17)

1. Create `internal/cli/commands/db_status.go` with basic structure
2. Implement `tracks db status` to show applied/pending migrations
3. Add status command tests

### Phase 5: Reset Command (Tasks 18-22)

1. Create `internal/cli/commands/db_reset.go` with basic structure
2. Implement `tracks db reset` with confirmation prompt
3. Add --force flag to skip confirmation
4. Implement database reset logic (drop tables, run migrations)
5. Add reset command tests

### Phase 6: Integration & Testing (Tasks 23-28)

1. Integration test: migrate command works in generated project
2. Integration test: rollback command works in generated project
3. Integration test: status command works in generated project
4. Integration test: reset command works in generated project
5. Test commands work with sqlite3 driver
6. Test commands work with postgres driver (Docker)

## Dependencies

### Prerequisites

- Epic 2.2 completed (migration infrastructure exists in generated projects)
- Phase 0 completed (CLI foundation)

### External Dependencies

- `github.com/pressly/goose/v3` - For migration operations
- `github.com/joho/godotenv` - For .env file loading
- Database drivers (already in tracks CLI)

### Blocks

- None (final epic before documentation)

## Acceptance Criteria

### Commands Exist

- [ ] `tracks db` shows help with available subcommands
- [ ] `tracks db migrate` command exists
- [ ] `tracks db rollback` command exists
- [ ] `tracks db status` command exists
- [ ] `tracks db reset` command exists

### Migrate Command

- [ ] `tracks db migrate` runs all pending migrations
- [ ] `tracks db migrate --steps 2` runs only 2 migrations
- [ ] `tracks db migrate --dry-run` shows migrations without running
- [ ] Exit code 0 on success, non-zero on failure
- [ ] Clear output showing which migrations ran

### Rollback Command

- [ ] `tracks db rollback` rolls back last migration
- [ ] `tracks db rollback --steps 3` rolls back 3 migrations
- [ ] Exit code 0 on success, non-zero on failure
- [ ] Clear output showing which migrations rolled back

### Status Command

- [ ] `tracks db status` shows applied migrations
- [ ] `tracks db status` shows pending migrations
- [ ] Clear formatting distinguishing applied vs pending
- [ ] Exit code 0 on success

### Reset Command

- [ ] `tracks db reset` prompts for confirmation
- [ ] `tracks db reset --force` skips confirmation
- [ ] Reset drops all tables and re-runs migrations
- [ ] Clear warning about data loss
- [ ] Exit code 0 on success

### Configuration

- [ ] Commands read DATABASE_URL from .env file
- [ ] Commands read DATABASE_URL from environment variable
- [ ] Environment variable takes precedence over .env
- [ ] Clear error message if DATABASE_URL not found
- [ ] Commands detect database driver from URL or .tracks.yaml

### Error Handling

- [ ] Clear error if not in a Tracks project directory
- [ ] Clear error if database connection fails
- [ ] Clear error if migration fails
- [ ] Helpful suggestions in error messages

### Testing

- [ ] Unit tests for command flag parsing
- [ ] Unit tests for project detection
- [ ] Unit tests for database connection
- [ ] Integration tests in generated projects
- [ ] All tests pass in CI

## Technical Notes

### Command Structure

```go
// internal/cli/commands/db.go
func NewDBCommand() *cobra.Command {
    cmd := &cobra.Command{
        Use:   "db",
        Short: "Database management commands",
    }

    cmd.AddCommand(
        NewDBMigrateCommand(),
        NewDBRollbackCommand(),
        NewDBStatusCommand(),
        NewDBResetCommand(),
    )

    return cmd
}
```

### Project Detection

```go
// Find .tracks.yaml in current or parent directories
func FindTracksProject() (*TracksProject, error) {
    // Start from current directory
    // Walk up until we find .tracks.yaml or hit root
    // Return project config or error
}
```

### Database Connection

```go
// Load configuration and connect
func ConnectToDatabase(projectDir string) (*sql.DB, string, error) {
    // Load .env file if exists
    // Get DATABASE_URL from env
    // Detect driver from URL or .tracks.yaml
    // Connect and return db, driver, error
}
```

### Status Output Format

```text
Database: postgres://localhost:5432/myapp
Driver: postgres

Applied Migrations:
  ✓ 20250128143022_initial_schema.sql
  ✓ 20250128143045_create_users.sql

Pending Migrations:
  ○ 20250128150000_add_posts.sql
  ○ 20250128151000_add_comments.sql

Total: 2 applied, 2 pending
```

### Reset Confirmation

```text
⚠️  WARNING: This will delete all data in the database!

Database: postgres://localhost:5432/myapp

This action will:
  - Drop all tables
  - Re-run all migrations
  - Delete all existing data

Are you sure? (y/N):
```

## Next Epic

[Epic 2.5: Audit, Integration & Documentation →](./2.5-audit-documentation.md)

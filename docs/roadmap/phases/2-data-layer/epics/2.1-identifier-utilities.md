# Epic 2.1: Identifier Utilities (UUIDv7 & Slugs)

[← Back to Phase 2](../../2-data-layer.md)

**Status:** Not Started

## Overview

Create template packages for identifier generation and validation in generated projects. This epic implements UUIDv7 for internal identifiers (database primary keys, foreign keys) and slug utilities for human-readable URLs. These packages are foundational utilities used throughout the application.

## Goals

- `internal/pkg/identifier/` package with UUIDv7 support
- `internal/pkg/slug/` package with slug generation utilities
- Unit tests for both packages
- Wire dependencies into go.mod template
- Wire templates into ProjectGenerator

## Scope

### In Scope

- uuid.go template with NewID, ValidateID, ExtractTimestamp functions
- uuid_test.go template with comprehensive unit tests
- slug.go template with Generate, GenerateShort, Sanitize, ValidateUsername functions
- slug_test.go template with unit tests
- Add gofrs/uuid/v5 to go.mod template
- Add go-nanoid to go.mod template
- Wire templates into ProjectGenerator
- Template rendering tests

### Out of Scope

- Database storage of identifiers (Epic 2.2)
- Using identifiers in example domains (Phase 4)
- Collision detection for slugs (application-level concern)
- Username availability checking (application-level concern)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Identifier Package Templates (Tasks 1-5)

1. Create `internal/pkg/identifier/uuid.go.tmpl` with NewID function using gofrs/uuid/v5
2. Add ValidateID function to uuid.go.tmpl for UUID validation
3. Add ExtractTimestamp function to uuid.go.tmpl for UUIDv7 timestamp extraction
4. Create `internal/pkg/identifier/uuid_test.go.tmpl` with unit tests
5. Add `github.com/gofrs/uuid/v5` to go.mod.tmpl

### Phase 2: Slug Package Templates (Tasks 6-10)

1. Create `internal/pkg/slug/slug.go.tmpl` with Generate function using go-nanoid
2. Add GenerateShort function to slug.go.tmpl (6-char slugs)
3. Add Sanitize function to slug.go.tmpl for user input sanitization
4. Add ValidateUsername function to slug.go.tmpl (3-32 chars, alphanumeric + hyphen/underscore)
5. Create `internal/pkg/slug/slug_test.go.tmpl` with unit tests

### Phase 3: Dependencies (Tasks 11-12)

1. Add `github.com/jaevor/go-nanoid` to go.mod.tmpl
2. Verify all identifier/slug dependencies resolve correctly

### Phase 4: ProjectGenerator Integration (Tasks 13-15)

1. Wire identifier package templates into ProjectGenerator
2. Wire slug package templates into ProjectGenerator
3. Add identifier and slug packages to pre-generate template list

### Phase 5: Testing & Validation (Tasks 16-18)

1. Template rendering tests for identifier package
2. Template rendering tests for slug package
3. Integration test: generated project with identifier/slug packages builds and tests pass

## Dependencies

### Prerequisites

- Phase 1 completed (project generation working)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/gofrs/uuid/v5` - UUIDv7 generation (RFC 9562)
- `github.com/jaevor/go-nanoid` - Cryptographically secure random strings

### Blocks

- Epic 2.2 (Goose Migrations) - uses UUIDv7 for ID columns in migrations

## Acceptance Criteria

### Templates Created

- [ ] `internal/templates/project/internal/pkg/identifier/uuid.go.tmpl` exists
- [ ] `internal/templates/project/internal/pkg/identifier/uuid_test.go.tmpl` exists
- [ ] `internal/templates/project/internal/pkg/slug/slug.go.tmpl` exists
- [ ] `internal/templates/project/internal/pkg/slug/slug_test.go.tmpl` exists
- [ ] All templates use Go template syntax correctly

### Identifier Package Functions

- [ ] `NewID()` returns valid UUIDv7 string
- [ ] `ValidateID(id)` returns nil for valid UUIDs, error for invalid
- [ ] `ExtractTimestamp(id)` returns time.Time from UUIDv7
- [ ] IDs are timestamp-ordered (later IDs sort after earlier IDs)

### Slug Package Functions

- [ ] `Generate()` returns 8-char URL-safe string
- [ ] `GenerateShort()` returns 6-char URL-safe string
- [ ] `Sanitize(input)` converts "Hello World!" to "hello-world"
- [ ] `ValidateUsername(username)` accepts "john-doe", rejects "ab", rejects "a".repeat(33)
- [ ] Slugs contain only alphanumeric and hyphens

### Generator Integration

- [ ] ProjectGenerator renders identifier package to `internal/pkg/identifier/`
- [ ] ProjectGenerator renders slug package to `internal/pkg/slug/`
- [ ] Dependencies appear in generated go.mod
- [ ] `go mod tidy` succeeds in generated project

### Generated Code Quality

- [ ] Generated code passes `go vet`
- [ ] Generated code passes `golangci-lint`
- [ ] Generated tests pass with `go test ./...`
- [ ] No import cycles with generated packages

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify generated project builds
- [ ] Integration tests verify generated tests pass
- [ ] All tests pass in CI

## Technical Notes

### UUIDv7 Format (RFC 9562)

```text
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         unix_ts_ms                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          unix_ts_ms           |  ver  |       rand_a          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|var|                       rand_b                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           rand_b                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- First 48 bits: Unix timestamp in milliseconds
- Next 4 bits: Version (7)
- Next 12 bits: Random
- Next 2 bits: Variant (RFC 4122)
- Remaining 62 bits: Random

### Slug Generation

Using go-nanoid for cryptographically secure random strings:

```go
alphabet := "0123456789abcdefghijklmnopqrstuvwxyz"
generator, _ := nanoid.CustomASCII(alphabet, 8)
slug := generator()
```

### Username Validation Rules

- Length: 3-32 characters
- Characters: alphanumeric, hyphen, underscore
- Cannot start/end with hyphen or underscore
- Cannot have consecutive hyphens or underscores
- Case-insensitive (stored lowercase)

## Next Epic

[Epic 2.2: Goose Migrations →](./2.2-goose-migrations.md)

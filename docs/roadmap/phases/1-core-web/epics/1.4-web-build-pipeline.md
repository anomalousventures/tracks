# Epic 1.4: Web Build Pipeline

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.3](./1.3-hashfs-assets.md)

## Overview

Establish the web build pipeline for TailwindCSS compilation, JavaScript bundling with esbuild, Alpine.js integration, and Air live reload configuration. This epic creates the complete frontend asset processing workflow with development and production modes, automatic rebuilds on file changes, and optimization for production deployments.

## Goals

- TailwindCSS configured to scan .templ files
- JIT mode for minimal CSS bundle sizes
- Dark mode support with class-based strategy
- esbuild for JavaScript bundling and minification
- Alpine.js integrated for minimal interactivity
- Air configured for live reload during development
- Makefile targets for asset building
- Development vs production build modes
- Source maps for debugging

## Scope

### In Scope

- TailwindCSS configuration (tailwind.config.js)
- Tailwind CLI via npx (no npm install required)
- JIT mode scanning .templ files
- Dark mode with class strategy
- Custom color palette and theme
- esbuild for JavaScript bundling
- Alpine.js integration (3.x)
- Source maps for development
- Minification for production
- Air configuration (.air.toml)
- Watch .templ, .css, .js files
- Rebuild assets on changes
- Makefile targets (assets, css, js, dev)
- PostCSS configuration (if needed)

### Out of Scope

- Templ-UI components (Epic 1.5)
- Complex JavaScript frameworks (React, Vue)
- TypeScript compilation (future)
- Sass/SCSS preprocessing
- CSS modules
- Advanced PostCSS plugins
- Service workers
- PWA manifest generation

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: TailwindCSS Foundation (Tasks 1-12)

1. **Create tailwind.config.js template**
   - Content paths scanning .templ files
   - Dark mode class strategy
   - Custom color palette
   - Custom theme extensions

2. **Create input CSS file (web/css/app.css)**
   - Tailwind directives (@tailwind base, components, utilities)
   - Custom CSS layer for project-specific styles
   - CSS custom properties for theming

3. **Add Makefile target for CSS compilation**
   - `make css` - compile Tailwind
   - Development mode (with source maps)
   - Production mode (minified)

4. **Configure Tailwind to scan templ files**
   - Content paths: `./internal/http/views/**/*.templ`
   - Scan components, layouts, pages
   - Document content configuration

5. **Add dark mode configuration**
   - Class-based strategy (`class="dark"`)
   - Document dark mode usage in components
   - Create dark mode toggle component (templ)

6. **Create custom color palette**
   - Primary, secondary, accent colors
   - Neutral grays
   - Success, warning, error, info colors
   - Document color system

7. **Add custom spacing scale (if needed)**
   - Extend default Tailwind spacing
   - Document custom spacing values

8. **Configure typography plugin (optional)**
   - @tailwindcss/typography for prose content
   - Custom prose styles
   - Document typography classes

9. **Add forms plugin (optional)**
   - @tailwindcss/forms for better form defaults
   - Custom form styles
   - Document form classes

10. **Create safelist for dynamic classes**
    - Classes generated dynamically (e.g., `bg-${color}-500`)
    - Prevent purging of dynamic classes
    - Document safelist usage

11. **Add custom utilities (if needed)**
    - Project-specific utility classes
    - Document custom utilities

12. **Test Tailwind compilation**
    - Verify CSS output
    - Check file size
    - Verify purging works

### Phase 2: JavaScript Pipeline (Tasks 13-24)

1. **Create JavaScript entry point (web/js/app.js)**
    - Import Alpine.js
    - Initialize Alpine
    - Export for testing

2. **Add Makefile target for JavaScript bundling**
    - `make js` - bundle with esbuild
    - Development mode (source maps)
    - Production mode (minified)

3. **Configure esbuild for bundling**
    - Entry point: web/js/app.js
    - Output: internal/assets/dist/app.js
    - Bundle format: IIFE
    - Target: ES2020

4. **Add Alpine.js integration**
    - Import Alpine from CDN or npm
    - Initialize Alpine.start()
    - Document Alpine usage patterns

5. **Create Alpine.js components**
    - Theme toggler (dark mode)
    - Mobile menu toggle
    - Dropdown menus
    - Modal dialogs

6. **Add Alpine.js store for global state**
    - Alpine.store('theme') for dark mode
    - LocalStorage persistence
    - Document store usage

7. **Create Alpine.js directives cheat sheet**
    - x-data, x-show, x-if, x-for
    - x-on, x-bind, x-model
    - x-transition, x-cloak
    - Document common patterns

8. **Add HTMX integration**
    - Load HTMX from CDN or bundle
    - Configure HTMX settings
    - Document HTMX + Alpine patterns

9. **Create JavaScript utilities**
    - Debounce, throttle helpers
    - Date formatting
    - API client helpers

10. **Add source map support**
    - Development builds include source maps
    - Production builds exclude source maps
    - Document debugging workflow

11. **Configure esbuild minification**
    - Minify for production
    - Preserve function names (for debugging)
    - Document build modes

12. **Test JavaScript bundling**
    - Verify bundle works in browser
    - Check bundle size
    - Test source maps

### Phase 3: Air Live Reload (Tasks 25-35)

1. **Create .air.toml configuration**
    - Watch .go, .templ, .css, .js files
    - Exclude generated files (*_templ.go)
    - Exclude vendor/, node_modules/

2. **Configure Air build command**
    - Run `make generate && make assets && go build`
    - Ensure correct order (generate → assets → build)
    - Document build sequence

3. **Add Air to tool directive in go.mod**
    - Add github.com/air-verse/air
    - Document Air installation

4. **Configure Air file watching**
    - Include .templ files in watch
    - Include .css files in web/
    - Include .js files in web/
    - Exclude internal/assets/dist/

5. **Set Air delay for rebuilds**
    - Delay: 1000ms (1 second)
    - Prevent rapid rebuilds
    - Document delay tuning

6. **Configure Air binary output**
    - Output to tmp/main
    - Clean tmp/ on exit
    - Exclude tmp/ from git

7. **Add Air run flags**
    - Pass environment variables
    - Configure logging
    - Document Air flags

8. **Create Makefile target for dev mode**
    - `make dev` - run Air
    - Sets APP_ENV=development
    - Document development workflow

9. **Test Air live reload**
    - Modify .templ file, verify reload
    - Modify .css file, verify rebuild
    - Modify .js file, verify rebuild
    - Modify .go file, verify rebuild

10. **Configure Air for cross-platform**
    - Works on Linux, macOS, Windows
    - Handle path separators
    - Document platform-specific notes

11. **Document Air troubleshooting**
    - Common issues (file watchers, delays)
    - Debugging Air configuration
    - Performance tips

### Phase 4: Build Targets (Tasks 36-45)

1. **Create Makefile target: make assets**
    - Runs `make css` and `make js`
    - Builds all frontend assets
    - Document assets target

2. **Create Makefile target: make css**
    - Compile Tailwind CSS
    - Output to internal/assets/dist/app.css
    - Development vs production modes

3. **Create Makefile target: make js**
    - Bundle JavaScript with esbuild
    - Output to internal/assets/dist/app.js
    - Development vs production modes

4. **Create Makefile target: make dev**
    - Run Air for live reload
    - Sets environment variables
    - Document dev workflow

5. **Create Makefile target: make build**
    - Run generate → assets → go build
    - Production builds
    - Document build workflow

6. **Add Makefile target: make clean**
    - Clean generated files
    - Clean asset outputs
    - Clean tmp/ directory

7. **Create Makefile target: make watch-css**
    - Watch CSS files and rebuild
    - Alternative to Air (CSS-only)
    - Document watch workflow

8. **Create Makefile target: make watch-js**
    - Watch JS files and rebuild
    - Alternative to Air (JS-only)
    - Document watch workflow

9. **Add environment-based build modes**
    - APP_ENV=development - dev builds
    - APP_ENV=production - optimized builds
    - Document build modes

10. **Document Makefile targets**
    - Reference guide for all targets
    - Usage examples
    - Common workflows

### Phase 5: Optimization & Testing (Tasks 46-50)

1. **Add PurgeCSS configuration (via Tailwind)**
    - Remove unused CSS in production
    - Safelist dynamic classes
    - Document purging

2. **Optimize bundle sizes**
    - Check CSS bundle size (<50KB target)
    - Check JS bundle size (<100KB target)
    - Document optimization strategies

3. **Add bundle analysis**
    - esbuild metafile for analysis
    - Visualize bundle composition
    - Document analysis tools

4. **Create build performance benchmarks**
    - Measure CSS compile time
    - Measure JS bundle time
    - Document build performance

5. **Test production builds**
    - Verify minification works
    - Verify source maps excluded
    - Verify asset hashing (Epic 1.3)
    - Test in browser

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Epic 1.3 completed (HashFS assets)
- Node.js 24+ (for npx Tailwind and esbuild)

### External Dependencies

- TailwindCSS (via npx)
- esbuild (via npx)
- Alpine.js (loaded via CDN or bundled)
- HTMX (loaded via CDN initially)
- Air (via `go tool air`)

### Blocks

- Epic 1.5 (Templ-UI Integration) - needs Tailwind and Alpine.js working

## Acceptance Criteria

### TailwindCSS

- [ ] tailwind.config.js configured to scan .templ files
- [ ] JIT mode enabled for minimal CSS
- [ ] Dark mode class strategy working
- [ ] Custom color palette defined
- [ ] CSS compiles successfully with `make css`
- [ ] Production builds purge unused CSS
- [ ] Source maps generated in development

### JavaScript & Alpine.js

- [ ] esbuild bundles JavaScript successfully
- [ ] Alpine.js integrated and functional
- [ ] Theme toggler works (dark mode)
- [ ] Mobile menu toggle works
- [ ] Alpine.js store configured for global state
- [ ] Source maps generated in development
- [ ] Production builds minified

### Air Live Reload

- [ ] Air configured to watch .templ, .css, .js files
- [ ] Changes trigger automatic rebuilds
- [ ] Build order correct (generate → assets → build)
- [ ] Excludes generated files from watch
- [ ] `make dev` runs Air successfully
- [ ] Cross-platform support (Linux, macOS, Windows)

### Build Targets

- [ ] `make assets` builds CSS and JS
- [ ] `make css` compiles Tailwind
- [ ] `make js` bundles JavaScript
- [ ] `make dev` runs Air with live reload
- [ ] `make build` creates production binary
- [ ] `make clean` removes generated files

### Documentation

- [ ] Tailwind configuration documented
- [ ] Alpine.js usage patterns documented
- [ ] Air configuration documented
- [ ] Makefile targets documented
- [ ] Development workflow documented

## Technical Notes

### TailwindCSS Configuration

```javascript
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './internal/http/views/**/*.templ',
  ],
  darkMode: 'class', // Use class="dark" for dark mode
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          // ... more shades
          900: '#0c4a6e',
        },
        secondary: {
          // ... secondary colors
        },
      },
    },
  },
  plugins: [],
}
```

### Input CSS File

```css
/* web/css/app.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom CSS layer */
@layer components {
  .btn {
    @apply px-4 py-2 rounded font-medium transition-colors;
  }

  .btn-primary {
    @apply bg-primary-600 text-white hover:bg-primary-700;
  }

  .btn-secondary {
    @apply bg-secondary-600 text-white hover:bg-secondary-700;
  }
}

/* CSS custom properties for theming */
:root {
  --color-bg: #ffffff;
  --color-text: #1f2937;
}

.dark {
  --color-bg: #1f2937;
  --color-text: #f9fafb;
}
```

### Makefile CSS Target

```makefile
.PHONY: css
css:
	@echo "Compiling CSS..."
	npx tailwindcss -i ./web/css/app.css -o ./internal/assets/dist/app.css --minify
```

### JavaScript Entry Point

```javascript
// web/js/app.js
import Alpine from 'alpinejs'

// Theme toggler component
Alpine.store('theme', {
  current: localStorage.getItem('theme') || 'light',

  toggle() {
    this.current = this.current === 'light' ? 'dark' : 'light'
    localStorage.setItem('theme', this.current)
    this.apply()
  },

  apply() {
    if (this.current === 'dark') {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  },

  init() {
    this.apply()
  }
})

// Initialize Alpine
window.Alpine = Alpine
Alpine.start()

// Initialize theme on page load
Alpine.store('theme').init()
```

### Makefile JavaScript Target

```makefile
.PHONY: js
js:
	@echo "Bundling JavaScript..."
	npx esbuild web/js/app.js \
		--bundle \
		--minify \
		--sourcemap \
		--target=es2020 \
		--outfile=internal/assets/dist/app.js
```

### Air Configuration

```toml
# .air.toml
root = "."
testdata_dir = "testdata"
tmp_dir = "tmp"

[build]
  # Build command
  cmd = "make generate && make assets && go build -o ./tmp/main ./cmd/server"
  bin = "tmp/main"

  # Watch these file extensions
  include_ext = ["go", "templ", "css", "js"]

  # Watch these directories
  include_dir = ["cmd", "internal", "web"]

  # Exclude these directories
  exclude_dir = ["tmp", "vendor", "node_modules", "internal/assets/dist"]

  # Exclude generated files
  exclude_regex = ["_test\\.go$", "_templ\\.go$"]

  # Delay before rebuilding
  delay = 1000

  # Stop running binary before building
  stop_on_error = true

  # Send interrupt signal before killing process
  send_interrupt = false

  # Delay after sending interrupt
  kill_delay = 500

[log]
  time = true

[color]
  main = "magenta"
  watcher = "cyan"
  build = "yellow"
  runner = "green"

[misc]
  # Delete tmp directory on exit
  clean_on_exit = true
```

### Dark Mode Toggle Component

```templ
// internal/http/views/components/theme-toggle.templ
package components

templ ThemeToggle() {
    <button
        @click="$store.theme.toggle()"
        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
        aria-label="Toggle theme"
    >
        <svg
            x-show="$store.theme.current === 'light'"
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
        >
            <!-- Moon icon -->
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
        </svg>

        <svg
            x-show="$store.theme.current === 'dark'"
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
        >
            <!-- Sun icon -->
            <path
                fill-rule="evenodd"
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                clip-rule="evenodd"
            />
        </svg>
    </button>
}
```

### Alpine.js Mobile Menu Example

```templ
// internal/http/views/components/nav.templ
package components

templ Nav() {
    <nav x-data="{ open: false }" class="bg-white dark:bg-gray-900 shadow">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="/" class="text-xl font-bold">MyApp</a>

                <!-- Desktop menu -->
                <div class="hidden md:flex space-x-4">
                    <a href="/about" class="hover:text-primary-600">About</a>
                    <a href="/contact" class="hover:text-primary-600">Contact</a>
                </div>

                <!-- Mobile menu button -->
                <button
                    @click="open = !open"
                    class="md:hidden p-2"
                    aria-label="Toggle menu"
                >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            x-show="!open"
                            fill-rule="evenodd"
                            d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                            clip-rule="evenodd"
                        />
                        <path
                            x-show="open"
                            fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd"
                        />
                    </svg>
                </button>
            </div>

            <!-- Mobile menu -->
            <div
                x-show="open"
                x-transition
                class="md:hidden pb-4"
            >
                <a href="/about" class="block py-2 hover:text-primary-600">About</a>
                <a href="/contact" class="block py-2 hover:text-primary-600">Contact</a>
            </div>
        </div>
    </nav>
}
```

### Build Modes (Development vs Production)

```makefile
# Makefile

# Development CSS build (with source maps, not minified)
.PHONY: css-dev
css-dev:
	npx tailwindcss -i ./web/css/app.css -o ./internal/assets/dist/app.css

# Production CSS build (minified, no source maps)
.PHONY: css-prod
css-prod:
	npx tailwindcss -i ./web/css/app.css -o ./internal/assets/dist/app.css --minify

# Auto-select based on APP_ENV
.PHONY: css
css:
ifeq ($(APP_ENV),production)
	@$(MAKE) css-prod
else
	@$(MAKE) css-dev
endif
```

### HTMX + Alpine.js Pattern

```templ
// Form with HTMX and Alpine.js
templ LoginForm() {
    <form
        hx-post="/login"
        hx-target="#login-result"
        x-data="{ submitting: false }"
        @htmx:before-request="submitting = true"
        @htmx:after-request="submitting = false"
    >
        <input type="email" name="email" required/>
        <input type="password" name="password" required/>

        <button
            type="submit"
            :disabled="submitting"
            :class="{ 'opacity-50 cursor-not-allowed': submitting }"
        >
            <span x-show="!submitting">Login</span>
            <span x-show="submitting">Logging in...</span>
        </button>
    </form>

    <div id="login-result"></div>
}
```

## Testing Strategy

### CSS Tests

- Verify Tailwind compilation succeeds
- Check CSS file size (<50KB target)
- Verify purging removes unused classes
- Test dark mode classes apply correctly

### JavaScript Tests

- Verify esbuild bundling succeeds
- Check bundle size (<100KB target)
- Test Alpine.js components in browser
- Verify source maps work in dev mode

### Air Tests

- Verify .templ changes trigger rebuild
- Verify .css changes trigger rebuild
- Verify .js changes trigger rebuild
- Verify .go changes trigger rebuild
- Test on Linux, macOS, Windows

### Integration Tests

- Full build pipeline (generate → assets → build)
- Development workflow (make dev)
- Production build workflow (make build)

## Next Epic

[Epic 1.5: Templ-UI Integration →](./1.5-templui-integration.md)

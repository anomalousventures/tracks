# Epic 1.1: Chi Router Setup

[← Back to Phase 1](../1-core-web.md)

## Overview

Create templates and generator logic to produce Chi-based HTTP servers in generated projects. This epic implements the template files for server structure with builder-pattern dependency injection, graceful shutdown handling, and route registration system following a HYPERMEDIA-first philosophy (serving HTML via templ, not JSON APIs). The ProjectGenerator will render these templates when running `tracks new`, creating a production-ready HTTP server foundation.

## Goals

- Templates for Chi v5 router setup in generated projects
- Server template with builder-pattern dependency injection
- Template for graceful shutdown with signal handling
- Route constants template for compile-time safety
- Route helper templates for type-safe URL generation
- HTTP configuration templates (timeouts, headers, TLS)
- Health check handler template
- ProjectGenerator integration to render all templates
- Generated projects build and run successfully

## Scope

### In Scope

- server.go template with builder pattern
- config.go template for HTTP configuration
- routes.go template for route registration
- routes/routes.go template for route constants
- handlers/health.go template
- cmd/server/main.go template
- Chi dependency in go.mod template
- HTTP config in .env.example template
- Makefile targets for server commands
- ProjectGenerator integration
- Tests that generated projects work

### Out of Scope

- Middleware templates (Epic 1.6)
- Template rendering system (Epic 1.2)
- Asset serving templates (Epic 1.3)
- TailwindCSS/Alpine.js (Epic 1.4)
- Templ-UI components (Epic 1.5)
- Authentication/authorization (Phase 3)
- Database connectivity (Phase 2)
- CRUD handler templates (future epics)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Server Templates (Tasks 1-10)

1. [#256](https://github.com/anomalousventures/tracks/issues/256) - Verify server.go template with Server struct and builder pattern
2. [#257](https://github.com/anomalousventures/tracks/issues/257) - Verify config.go template for HTTP server configuration
3. [#258](https://github.com/anomalousventures/tracks/issues/258) - Verify routes.go template for route registration method
4. [#259](https://github.com/anomalousventures/tracks/issues/259) - **REFACTORED:** Update routes/routes.go to shared routes only (API prefix, sitemap, robots)
5. [#260](https://github.com/anomalousventures/tracks/issues/260) - Verify handlers/health.go template for health check endpoint
6. [#261](https://github.com/anomalousventures/tracks/issues/261) - Verify cmd/server/main.go template with graceful shutdown
7. [#262](https://github.com/anomalousventures/tracks/issues/262) - Verify Chi v5 dependency in go.mod template
8. [#263](https://github.com/anomalousventures/tracks/issues/263) - Verify HTTP configuration in .env.example template
9. [#264](https://github.com/anomalousventures/tracks/issues/264) - Verify server targets in Makefile template
10. [#265](https://github.com/anomalousventures/tracks/issues/265) - **REPURPOSED:** Create routes/health.go template for health domain routes

### Phase 2: ProjectGenerator Integration (Tasks 11-20)

1. [#266](https://github.com/anomalousventures/tracks/issues/266) - Verify server.go template wired into ProjectGenerator
2. [#267](https://github.com/anomalousventures/tracks/issues/267) - Verify config.go template wired into ProjectGenerator
3. [#268](https://github.com/anomalousventures/tracks/issues/268) - Verify routes.go template wired into ProjectGenerator
4. [#269](https://github.com/anomalousventures/tracks/issues/269) - Verify routes/routes.go template wired into ProjectGenerator
5. [#270](https://github.com/anomalousventures/tracks/issues/270) - Verify handlers/health.go template wired into ProjectGenerator
6. [#271](https://github.com/anomalousventures/tracks/issues/271) - Verify cmd/server/main.go template wired into ProjectGenerator
7. [#272](https://github.com/anomalousventures/tracks/issues/272) - Verify go.mod template rendering includes Chi v5
8. [#273](https://github.com/anomalousventures/tracks/issues/273) - Verify .env.example template rendering includes HTTP config
9. [#274](https://github.com/anomalousventures/tracks/issues/274) - Verify Makefile template rendering includes server targets
10. [#275](https://github.com/anomalousventures/tracks/issues/275) - **UPDATED:** Wire health and example user templates into generation workflow

### Phase 3: Testing & Validation (Tasks 21-27)

1. [#276](https://github.com/anomalousventures/tracks/issues/276) - Test generated server.go has correct structure
2. [#277](https://github.com/anomalousventures/tracks/issues/277) - Test generated config.go loads from environment
3. [#278](https://github.com/anomalousventures/tracks/issues/278) - Test generated routes.go registers routes correctly
4. [#279](https://github.com/anomalousventures/tracks/issues/279) - Test generated health endpoint returns 200 OK
5. [#280](https://github.com/anomalousventures/tracks/issues/280) - Test generated cmd/server/main.go builds successfully
6. [#281](https://github.com/anomalousventures/tracks/issues/281) - Integration test: generated project compiles
7. [#282](https://github.com/anomalousventures/tracks/issues/282) - Integration test: generated server starts and responds to requests

### Phase 4: Documentation (Tasks 28-30)

**Philosophy:** Generated README contains minimal dev info with links to official Tracks docs site. Comprehensive documentation lives on the website for easy maintenance and updates.

1. [#283](https://github.com/anomalousventures/tracks/issues/283) - Add server architecture link to README (links to official docs)
2. [#284](https://github.com/anomalousventures/tracks/issues/284) - Add routing philosophy link emphasizing HYPERMEDIA-first approach
3. [#285](https://github.com/anomalousventures/tracks/issues/285) - Create Chi router troubleshooting guide on official website

### Phase 5: Routes Package Refactor (Tasks 31-35)

**Purpose:** Refactor routes package to domain-based structure with HYPERMEDIA-first philosophy

1. [#286](https://github.com/anomalousventures/tracks/issues/286) - Create routes/health_test.go template for health domain tests
2. [#287](https://github.com/anomalousventures/tracks/issues/287) - Create routes/users.go example template showing HYPERMEDIA routes (reference for code generation)
3. [#288](https://github.com/anomalousventures/tracks/issues/288) - Create routes/users_test.go example template for HYPERMEDIA routes
4. [#289](https://github.com/anomalousventures/tracks/issues/289) - Wire health.go and health_test.go templates into ProjectGenerator
5. [#290](https://github.com/anomalousventures/tracks/issues/290) - Update official docs to emphasize HYPERMEDIA-first routing

**New Structure:**

```text
internal/http/routes/
├── routes.go       # Shared routes (API prefix, /sitemap.xml, /robots.txt, /.well-known/*)
├── health.go       # Health domain routes (API endpoint - no params, no helpers)
├── health_test.go  # Health domain tests
├── users.go        # Example: User HYPERMEDIA routes + userSlug + RouteURL + helpers (NOT generated by default)
└── users_test.go   # Example: User domain tests (NOT generated by default)
```

**Key Patterns:**

- **HYPERMEDIA-first:** Routes serve HTML via templ (e.g., `/users/:username`), NOT JSON APIs
- **Slug constants:** Private per-domain (userSlug, postSlug) - prevents magic strings
- **RouteURL helper:** Each domain has its own copy for independence
- **Helper functions:** Domain-specific (UserShow, UserEdit, etc.) for type safety
- **Form routes:** Include `/new` and `/edit` routes for HTML forms (HYPERMEDIA pattern)
- **Testing:** Per-domain test files for isolation
- **API resources:** Optional via `tracks generate resource --api` flag for rare JSON API needs

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/go-chi/chi/v5` - HTTP router (added to generated go.mod)
- `github.com/spf13/viper` - Configuration (already in Phase 0)
- Standard library: `net/http`, `context`, `os/signal`, `syscall`

### Blocks

- Epic 1.2 (Templ Templates) - needs routes registered for template rendering
- Epic 1.3 (HashFS Assets) - needs static file route pattern
- Epic 1.6 (Middleware) - needs server and routes foundation

## Acceptance Criteria

### Templates Created

- [ ] server.go template exists in internal/templates/
- [ ] config.go template exists in internal/templates/
- [ ] routes.go template exists in internal/templates/
- [ ] routes/routes.go template exists in internal/templates/
- [ ] handlers/health.go template exists in internal/templates/
- [ ] cmd/server/main.go template exists in internal/templates/
- [ ] All templates use Go template syntax correctly

### Generator Integration

- [ ] ProjectGenerator renders server.go to internal/http/
- [ ] ProjectGenerator renders config.go to internal/http/
- [ ] ProjectGenerator renders routes.go to internal/http/
- [ ] ProjectGenerator renders routes/routes.go to internal/http/routes/
- [ ] ProjectGenerator renders handlers/health.go to internal/http/handlers/
- [ ] ProjectGenerator renders cmd/server/main.go to cmd/server/
- [ ] Chi dependency appears in generated go.mod
- [ ] HTTP config appears in generated .env.example
- [ ] Server targets appear in generated Makefile

### Generated Code Quality

- [ ] Generated code passes `go vet`
- [ ] Generated code passes `golangci-lint`
- [ ] Generated server builds successfully
- [ ] Generated server starts and listens on configured port
- [ ] Health endpoint returns 200 OK with JSON
- [ ] Graceful shutdown works on SIGINT/SIGTERM

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify generated project builds
- [ ] Integration tests verify generated server runs
- [ ] All tests pass in CI

## Next Epic

[Epic 1.2: Templ Templates →](./1.2-templ-templates.md)

# Epic 1.1: Chi Router Setup

[← Back to Phase 1](../1-core-web.md)

## Overview

Establish the Chi router foundation for generated web applications. This epic implements the HTTP server structure with builder-pattern dependency injection, graceful shutdown handling, and the basic route registration system. This creates the foundation for all subsequent web layer features including middleware, templates, and assets.

## Goals

- Chi v5 router integrated into generated projects
- Builder-pattern server structure with dependency injection
- Graceful shutdown with context-based signal handling
- Route constants pattern for compile-time safety
- Route helper functions for type-safe URL generation
- Comprehensive HTTP configuration (timeouts, headers, TLS)
- Health check endpoint for Kubernetes/load balancer probes
- Static file serving preparation (hashfs integration in Epic 1.3)

## Scope

### In Scope

- Chi router initialization and configuration
- Server struct with builder-pattern dependency injection
- Route constants file (`internal/http/routes/routes.go`)
- Route helper functions for templ templates
- Graceful shutdown with signal handling (SIGINT, SIGTERM)
- HTTP server configuration (read/write timeouts, max header bytes)
- Health check handler (`/health`)
- Basic route registration pattern
- Server entry point in `cmd/server/main.go`
- HTTP configuration via environment variables (port, host, timeouts)
- Cross-platform signal handling

### Out of Scope

- Middleware implementation (Epic 1.6)
- Template rendering (Epic 1.2)
- Asset serving with hashfs (Epic 1.3)
- TailwindCSS and Alpine.js (Epic 1.4)
- Templ-UI components (Epic 1.5)
- Authentication/authorization (Phase 3)
- Database connectivity (Phase 2)
- Full CRUD handlers (future epics)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Chi Router Foundation (Tasks 1-8)

1. Add Chi v5 dependency to generated go.mod
2. Create server.go with Server struct and builder pattern
3. Create Config struct for HTTP server configuration
4. Implement graceful shutdown with signal handling
5. Create routes constants file (internal/http/routes/routes.go)
6. Add route helper functions for path generation
7. Create health check handler
8. Wire up basic route registration in routes() method

### Phase 2: Server Entry Point (Tasks 9-15)

1. Create cmd/server/main.go entry point
2. Add server configuration loading via Viper
3. Implement ListenAndServe() with http.Server configuration
4. Add TLS support for HTTPS
5. Create Makefile target for running server
6. Add context propagation through request lifecycle
7. Create server unit tests

### Phase 3: Route Patterns & Templates (Tasks 16-22)

1. Generate route constants template in internal/templates/
2. Generate server.go template
3. Generate main.go template for cmd/server/
4. Generate HTTP config template for .env.example
5. Add route helper generation to ProjectGenerator
6. Update Makefile template with server targets
7. Document Chi router setup in generated README

### Phase 4: Advanced Configuration (Tasks 23-30)

1. Add request timeout middleware (chi built-in)
2. Add max body size configuration
3. Implement structured logging integration point
4. Add server shutdown timeout configuration
5. Create integration test for server lifecycle
6. Add HTTP/2 support
7. Document hypermedia routing patterns
8. Create Chi router troubleshooting guide

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/go-chi/chi/v5` - HTTP router
- `github.com/spf13/viper` - Configuration management (already in Phase 0)
- Standard library: `net/http`, `context`, `os/signal`, `syscall`

### Blocks

- Epic 1.2 (Templ Templates) - needs routes registered for template rendering
- Epic 1.3 (HashFS Assets) - needs static file route pattern
- Epic 1.6 (Middleware) - needs server and routes foundation

## Acceptance Criteria

### Server Infrastructure

- [ ] Chi v5 router initialized in generated projects
- [ ] Server struct uses builder pattern for dependency injection
- [ ] Graceful shutdown works on SIGINT and SIGTERM
- [ ] HTTP configuration loaded from environment variables
- [ ] Server listens on configured host and port
- [ ] Timeouts configured (read, write, idle, shutdown)

### Routing

- [ ] Route constants defined in `internal/http/routes/routes.go`
- [ ] Route helper functions generate type-safe paths
- [ ] templ.SafeURL helpers available for templates
- [ ] Health check endpoint returns 200 OK with JSON
- [ ] Routes organized by category (pages, actions, static)

### Configuration

- [ ] `.env.example` includes all HTTP configuration options
- [ ] Viper loads config from environment and .env file
- [ ] Default values provided for all config options
- [ ] TLS support works when cert/key files provided
- [ ] Configuration documented in generated README

### Testing & Documentation

- [ ] Server unit tests pass
- [ ] Integration test verifies server lifecycle
- [ ] Makefile includes run-server and dev targets
- [ ] README documents server structure and route patterns
- [ ] Troubleshooting guide created

## Next Epic

[Epic 1.2: Templ Templates →](./1.2-templ-templates.md)

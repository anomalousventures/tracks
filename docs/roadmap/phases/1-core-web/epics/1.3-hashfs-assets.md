# Epic 1.3: HashFS Assets

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.2](./1.2-templ-templates.md)

## Overview

Create templates and generator logic for content-addressed asset serving using hashfs in generated projects. This epic implements template files for asset embedding, hash generation, cache headers, and compression. The ProjectGenerator will render these templates when running `tracks new`, creating production-ready asset serving with immutable URLs and optimal caching.

## Goals

- Templates for hashfs-based asset serving in generated projects
- Asset directory structure templates (web/css/, web/js/, web/images/)
- Asset embedding templates with go:embed
- Hash generation templates for cache busting
- Asset helper templates for templates
- Compression middleware templates
- Generated projects serve assets correctly with caching

## Scope

### In Scope

- assets.go template with go:embed and hashFS initialization
- web/ directory structure template
- Asset helper function templates (AssetURL, CSS, JS, Image)
- Static file handler template
- Cache header middleware template
- Compression middleware template
- Development mode template (no hashing)
- Production mode template (embedded + hashed)
- Asset tests in generated projects
- ProjectGenerator integration

### Out of Scope

- TailwindCSS compilation (Epic 1.4)
- JavaScript bundling (Epic 1.4)
- Alpine.js integration (Epic 1.4)
- Image processing/optimization (basic support only)
- CDN integration (future)
- Service worker / offline support (future)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Asset Infrastructure Templates (Tasks 1-10)

1. Create web/ directory structure template
2. Create assets.go template with go:embed directive
3. Create hashFS initialization template
4. Create AssetURL helper function template
5. Create development mode asset serving template
6. Create production mode asset serving template
7. Create environment-based mode selection template
8. Add hashfs dependency to go.mod template
9. Create .gitkeep files template for empty asset directories
10. Document asset embedding workflow in generated README template

### Phase 2: Static File Serving Templates (Tasks 11-20)

1. Create static file handler template
2. Create asset route registration template for routes.go
3. Create cache header middleware template (1 year for hashed)
4. Create ETag support template
5. Create compression middleware template (gzip)
6. Create CORS headers template for fonts
7. Create MIME type handling template
8. Create 404 handler template for missing assets
9. Update routes.go template to register asset route
10. Create asset serving tests template

### Phase 3: Template Helper Templates (Tasks 21-30)

1. Create CSS helper template for templates
2. Create JS helper template for templates
3. Create Image helper template for templates
4. Create Preload helper template for critical assets
5. Create Favicon helper template
6. Update base layout template to use asset helpers
7. Create inline asset helper template (for critical CSS)
8. Create asset manifest generation template (optional)
9. Document template asset helpers in generated README
10. Create asset helper tests template

### Phase 4: Testing & Optimization Templates (Tasks 31-40)

1. Create asset serving unit test template
2. Create asset hashing test template
3. Create cache header test template
4. Create compression test template
5. Create integration test template for asset serving
6. Create asset inventory script template
7. Create asset optimization documentation template
8. Create responsive image helper template
9. Create lazy loading pattern template
10. Document asset performance best practices template

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Go 1.25+ (embed directive support)

### External Dependencies

- `github.com/benbjohnson/hashfs` - Content-addressed file system (added to generated go.mod)
- `github.com/go-chi/chi/v5/middleware` - Compression middleware
- Standard library: `embed`, `net/http`, `io/fs`

### Blocks

- Epic 1.4 (Web Build Pipeline) - needs asset serving for compiled CSS/JS
- Epic 1.5 (Templ-UI Integration) - needs asset helpers in components

## Acceptance Criteria

### Templates Created

- [ ] assets.go template exists with go:embed
- [ ] Asset helper templates exist (AssetURL, CSS, JS, Image)
- [ ] Static file handler template exists
- [ ] Cache middleware template exists
- [ ] Compression middleware template exists
- [ ] Asset test templates exist
- [ ] web/ directory structure template exists

### Generator Integration

- [ ] ProjectGenerator creates web/ directory structure
- [ ] ProjectGenerator renders assets.go
- [ ] ProjectGenerator renders asset helpers
- [ ] ProjectGenerator renders static file handler
- [ ] HashFS dependency appears in generated go.mod
- [ ] Asset route registered in generated routes.go

### Generated Code Quality

- [ ] Generated assets.go embeds files correctly
- [ ] Generated asset helpers return correct URLs
- [ ] Generated cache headers set correctly (1 year)
- [ ] Generated compression works (gzip)
- [ ] Generated asset tests pass
- [ ] Generated code passes `go vet` and `golangci-lint`

### Testing

- [ ] Unit tests verify asset embedding in tracks repo
- [ ] Generated project's asset tests pass (verified by e2e-workflow)
- [ ] Integration tests verify assets served correctly
- [ ] All CI jobs pass

## Next Epic

[Epic 1.4: Web Build Pipeline →](./1.4-web-build-pipeline.md)

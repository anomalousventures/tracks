# Epic 1.3: HashFS Assets

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.2](./1.2-templ-templates.md)

## Overview

Implement content-addressed asset serving using Ben Johnson's hashfs library. This epic establishes automatic asset embedding with `go:embed`, content-based cache busting through SHA-256 hashing, optimal cache headers for browser caching, and compression support. HashFS ensures deployed assets have immutable URLs that can be cached forever, while content changes automatically generate new URLs.

## Goals

- Asset embedding with `go:embed` directive
- Content-based hash generation (SHA-256) for cache busting
- Immutable asset URLs with far-future cache headers
- Compression support (gzip, brotli)
- Asset helper functions for templates
- Development vs production asset modes
- Static file serving integrated with Chi router
- Image optimization workflow

## Scope

### In Scope

- HashFS integration (`github.com/benbjohnson/hashfs`)
- Asset embedding from `web/` directory
- Content hash generation for all static files
- Cache header configuration (1 year for hashed assets)
- Helper functions for asset URLs in templates
- Compression middleware (gzip via chi middleware)
- Development mode (direct file serving, no caching)
- Production mode (embedded + hashed + cached)
- Asset directory structure (`web/css/`, `web/js/`, `web/images/`)
- Chi route for serving static files
- Asset URL generation helper

### Out of Scope

- TailwindCSS compilation (Epic 1.4)
- JavaScript bundling with esbuild (Epic 1.4)
- Alpine.js integration (Epic 1.4)
- Image processing/optimization (basic support only)
- CDN integration (future)
- Service worker / offline support (future)
- Asset preloading strategies (future)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: HashFS Foundation (Tasks 1-10)

1. Add hashfs dependency to generated go.mod
2. Create asset directory structure
3. Create assets package (internal/assets/assets.go)
4. Implement asset embedding with go:embed
5. Initialize hashFS in assets package
6. Add asset helper function for URL generation
7. Create development mode asset serving
8. Add production mode with hashing
9. Create environment-based mode selection
10. Document asset embedding workflow

### Phase 2: Chi Integration (Tasks 11-20)

1. Create static file handler
2. Register asset route in Chi router
3. Add cache headers for hashed assets
4. Implement ETag support
5. Add compression middleware
6. Create asset middleware for headers
7. Add CORS headers for fonts
8. Implement range request support
9. Create asset serving tests
10. Document static file serving

### Phase 3: Template Helpers (Tasks 21-30)

1. Create AssetURL helper for templates
2. Add CSS helper (CSS function)
3. Add JS helper (JS function)
4. Add Image helper (Image function)
5. Create preload helper for critical assets
6. Add favicon helpers
7. Update base layout to use asset helpers
8. Create asset manifest generation (optional)
9. Add inline asset helper (for critical CSS)
10. Document template asset helpers

### Phase 4: Asset Optimization (Tasks 31-40)

1. Create image optimization documentation
2. Add SVG optimization workflow
3. Create responsive image helper
4. Add lazy loading support
5. Implement image placeholder pattern
6. Create font loading strategy
7. Add asset size budgets (documentation)
8. Create asset inventory script
9. Add asset versioning for cache invalidation
10. Document asset performance best practices

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Go 1.25+ (embed directive support)

### External Dependencies

- `github.com/benbjohnson/hashfs` - Content-addressed file system
- `github.com/go-chi/chi/v5/middleware` - Compression middleware
- Standard library: `embed`, `net/http`, `io/fs`

### Blocks

- Epic 1.4 (Web Build Pipeline) - needs asset serving for compiled CSS/JS
- Epic 1.5 (Templ-UI Integration) - needs asset helpers in components

## Acceptance Criteria

### Asset Infrastructure

- [ ] HashFS initialized with embedded assets
- [ ] Asset directory structure created (`web/css/`, `web/js/`, `web/images/`)
- [ ] go:embed directive embeds `web/` directory
- [ ] Content hashes generated for all assets (SHA-256)
- [ ] Development mode serves files directly without hashing
- [ ] Production mode serves embedded hashed assets

### Serving & Caching

- [ ] `/assets/*` route registered in Chi router
- [ ] Cache headers set correctly (1 year for hashed assets)
- [ ] ETag support for conditional requests (304 responses)
- [ ] Compression middleware enabled (gzip)
- [ ] MIME types set correctly for all file types
- [ ] 404 handling for missing assets

### Template Integration

- [ ] AssetURL helper returns content-hashed URLs
- [ ] CSS, JS, Image helpers available in templates
- [ ] Base layout uses asset helpers
- [ ] Helpers work in both development and production modes
- [ ] Preload helpers generate correct link tags

### Documentation

- [ ] Asset embedding workflow documented
- [ ] Cache strategy documented
- [ ] Template helpers documented with examples
- [ ] Asset optimization best practices guide created

## Next Epic

[Epic 1.4: Web Build Pipeline →](./1.4-web-build-pipeline.md)

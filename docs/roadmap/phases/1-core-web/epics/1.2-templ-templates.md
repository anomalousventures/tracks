# Epic 1.2: Templ Templates

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.1](./1.1-chi-router-setup.md)

## Overview

Integrate templ for type-safe, compile-time HTML templating in generated applications. This epic establishes the view layer directory structure, creates base layout templates, implements component patterns, and integrates templ generation into the build workflow. Templ provides Go's type safety and IDE support for HTML templates, catching errors at compile time rather than runtime.

## Goals

- Templ installed and configured in generated projects
- Directory structure for views (layouts, pages, components)
- Base layout template with common HTML structure
- Component composition patterns established
- Templ generation integrated into `make generate`
- Type-safe props and component interfaces
- CSP-compliant templates (no inline scripts/styles)
- Integration with Chi router for rendering

## Scope

### In Scope

- Templ CLI added to `tool` directive in go.mod
- View directory structure (`internal/http/views/`)
- Base layout template (`layouts/base.templ`)
- Example page templates (`pages/home.templ`, `pages/about.templ`)
- Component directory structure (`components/`)
- Helper functions for common patterns (conditional classes, safe URLs)
- Templ generation in Makefile (`make generate`)
- Handler integration (rendering templ components)
- Component props validation
- Dark mode class toggling patterns
- HTMX attribute helpers

### Out of Scope

- Templ-UI component library (Epic 1.5)
- TailwindCSS compilation (Epic 1.4)
- Alpine.js integration (Epic 1.4)
- Asset serving with hashfs (Epic 1.3)
- Full CRUD page examples (future epics)
- Client-side JavaScript beyond HTMX attributes
- Complex component libraries (Epic 1.5)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Templ Foundation (Tasks 1-10)

1. **Add templ to tool directive in generated go.mod**
   - Add `github.com/a-h/templ` with latest version
   - Document version constraints

2. **Create view directory structure**
   - `internal/http/views/layouts/`
   - `internal/http/views/pages/`
   - `internal/http/views/components/`
   - Document directory organization

3. **Add templ generation to Makefile**
   - `generate` target runs `go tool templ generate`
   - Runs alongside sqlc and mockery
   - Document generation workflow

4. **Create .templignore for excluding directories**
   - Exclude vendor/, node_modules/, tmp/
   - Exclude generated outputs
   - Document ignore patterns

5. **Configure templ to generate to same directory**
   - Output `*_templ.go` files next to `.templ` files
   - Maintain 1:1 file correspondence
   - Document generated file patterns

6. **Create helper functions package (views/helpers.go)**
   - `ClassNames(conditions map[string]bool) string` - conditional classes
   - `SafeHTML(s string) templ.Component` - sanitized HTML
   - `FormatDate(t time.Time) string` - date formatting
   - Document helper usage

7. **Add HTMX attribute helpers**
   - `HXGet(url string) templ.Attributes`
   - `HXPost(url string) templ.Attributes`
   - `HXTarget(selector string) templ.Attributes`
   - `HXSwap(strategy string) templ.Attributes`

8. **Create component props pattern documentation**
   - Struct-based props with validation
   - Optional vs required fields
   - Type-safe prop passing

9. **Document templ syntax basics**
   - `{ children... }` - render child content
   - `@ComponentName()` - invoke component
   - `if/else`, `for`, `switch` control flow
   - String interpolation

10. **Add templ LSP configuration for editors**
    - VS Code settings.json template
    - Document editor setup

### Phase 2: Base Layout (Tasks 11-20)

11. **Create base layout template (layouts/base.templ)**
    - HTML5 boilerplate structure
    - `<head>` with meta tags
    - Asset links (CSS, JavaScript)
    - `{ children... }` for page content

12. **Add meta tags component (components/meta.templ)**
    - Title, description, charset
    - Viewport configuration
    - Open Graph tags
    - Props: `Title`, `Description`, `OGImage`

13. **Create nav component (components/nav.templ)**
    - Site navigation with route helpers
    - Active link highlighting
    - Responsive mobile menu structure
    - Props: `CurrentPath`, `IsAuthenticated`

14. **Create footer component (components/footer.templ)**
    - Copyright notice
    - Links (About, Privacy, Terms)
    - Props: `AppName`, `Year`

15. **Add dark mode toggle component**
    - Theme switcher button
    - Alpine.js `x-data` for state
    - LocalStorage persistence
    - Props: `CurrentTheme`

16. **Create flash message component**
    - Success, error, warning, info variants
    - Dismissible with Alpine.js
    - Auto-hide after timeout
    - Props: `Type`, `Message`, `Dismissible`

17. **Add breadcrumb component**
    - Navigation breadcrumbs
    - Schema.org markup
    - Props: `Crumbs []BreadcrumbItem`

18. **Create layout template with sidebar**
    - Two-column layout option
    - Responsive sidebar
    - Props: `ShowSidebar`, `SidebarContent`

19. **Add CSP-compliant script loading**
    - No inline scripts
    - Nonce-based script tags
    - Document CSP integration

20. **Create layout composition example**
    - Nested layouts (base → dashboard → page)
    - Slot-based content areas
    - Document layout patterns

### Phase 3: Page Templates (Tasks 21-30)

21. **Create home page template (pages/home.templ)**
    - Uses base layout
    - Hero section
    - Feature cards
    - CTA buttons

22. **Create about page template (pages/about.templ)**
    - Static content example
    - Image integration
    - Link to other pages

23. **Create error page templates**
    - 404 Not Found
    - 500 Internal Server Error
    - 403 Forbidden
    - Props: `ErrorCode`, `Message`, `Details`

24. **Add login page template (pages/login.templ)**
    - Form with HTMX
    - CSRF token field
    - Validation error display
    - Props: `CSRFToken`, `Errors`

25. **Create registration page template (pages/register.templ)**
    - Multi-field form
    - Password strength indicator
    - Terms acceptance
    - Props: `CSRFToken`, `Errors`, `FormData`

26. **Add user profile page template (pages/profile.templ)**
    - Display user information
    - Edit profile link
    - Activity feed
    - Props: `User`, `IsOwner`

27. **Create dashboard page template (pages/dashboard.templ)**
    - Uses sidebar layout
    - Stats cards
    - Recent activity
    - Props: `Stats`, `RecentItems`

28. **Add settings page template (pages/settings.templ)**
    - Tabbed interface (Profile, Security, Preferences)
    - Form sections
    - Save buttons with HTMX
    - Props: `ActiveTab`, `Settings`

29. **Create list page template pattern**
    - Pagination component
    - Filter/search form
    - Item cards
    - Props: `Items`, `Pagination`, `Filters`

30. **Add detail page template pattern**
    - Item header
    - Action buttons
    - Related content
    - Props: `Item`, `RelatedItems`

### Phase 4: Handler Integration (Tasks 31-40)

31. **Create handler helper for rendering templ**
    - `RenderTemplate(w, r, component)` function
    - Error handling
    - Content-Type header
    - HTTP status code support

32. **Update home handler to use templ**
    - Create page data struct
    - Render home.templ
    - Pass props from handler

33. **Update about handler to use templ**
    - Static page example
    - Minimal props

34. **Create error handler with templ**
    - Render error pages
    - Log errors
    - User-friendly messages

35. **Add handler tests with templ rendering**
    - Test template rendering
    - Verify generated HTML
    - Check prop passing

36. **Create template data builders**
    - Builder pattern for page props
    - Type-safe data construction
    - Default values

37. **Add context helpers for templates**
    - Extract user from context
    - Extract flash messages
    - Extract CSRF token

38. **Create partial rendering pattern**
    - HTMX partial responses
    - Render component without layout
    - Props: `ComponentOnly bool`

39. **Add template error handling**
    - Catch render errors
    - Log template errors
    - Fallback error page

40. **Document handler-to-template integration**
    - Data flow from handler to view
    - Props pattern
    - Error handling

### Phase 5: Advanced Patterns (Tasks 41-50)

41. **Create form component library**
    - Input, Textarea, Select, Checkbox, Radio
    - Label with required indicator
    - Error message display
    - Props: `Name`, `Value`, `Error`, `Required`

42. **Add form validation display**
    - Field-level errors
    - Form-level errors
    - Success messages
    - Props: `FieldErrors map[string]string`

43. **Create table component**
    - Sortable headers
    - Pagination
    - Row actions
    - Props: `Headers`, `Rows`, `Actions`

44. **Add modal component**
    - Overlay backdrop
    - Close button
    - Alpine.js for show/hide
    - Props: `ID`, `Title`, `Content`

45. **Create card component library**
    - Basic card, Image card, Stats card
    - Hover effects
    - Click actions
    - Props: `Title`, `Image`, `Content`, `Actions`

46. **Add badge component**
    - Color variants (success, error, warning, info)
    - Size variants (small, medium, large)
    - Props: `Label`, `Variant`, `Size`

47. **Create avatar component**
    - Image with fallback initials
    - Size variants
    - Online indicator
    - Props: `ImageURL`, `Name`, `Online`, `Size`

48. **Add dropdown menu component**
    - Trigger button
    - Menu items with icons
    - Alpine.js for state
    - Props: `Items`, `TriggerLabel`

49. **Create pagination component**
    - Previous/Next buttons
    - Page numbers
    - Current page highlight
    - Props: `CurrentPage`, `TotalPages`, `BaseURL`

50. **Document component composition patterns**
    - Passing components as props
    - Slot-based composition
    - Conditional rendering
    - Loop rendering

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Epic 1.1 completed (Chi router and routes)
- Go 1.25+ (tool directive support)

### External Dependencies

- `github.com/a-h/templ` - Template engine
- Standard library: `html/template` (for SafeHTML helper)
- HTMX (loaded via CDN initially, Epic 1.4 for bundling)

### Blocks

- Epic 1.3 (HashFS Assets) - needs templates for asset URL helpers
- Epic 1.4 (Web Build Pipeline) - needs templates for TailwindCSS class scanning
- Epic 1.5 (Templ-UI Integration) - builds on component patterns

## Acceptance Criteria

### Templ Infrastructure

- [ ] Templ CLI installed in tool directive
- [ ] View directory structure created
- [ ] Templ generation runs with `make generate`
- [ ] Generated `*_templ.go` files colocated with `.templ` files
- [ ] `.templignore` excludes vendor and generated directories

### Templates & Components

- [ ] Base layout template functional
- [ ] Meta tags, nav, footer components working
- [ ] Home, about, error page templates created
- [ ] Login, registration templates with forms
- [ ] Component props pattern documented
- [ ] Helper functions available (ClassNames, SafeHTML, etc.)
- [ ] HTMX attribute helpers working

### Handler Integration

- [ ] Handler helper renders templ components
- [ ] Home and about handlers use templ
- [ ] Error handlers render error pages
- [ ] Handler tests verify template rendering
- [ ] Context helpers extract common data

### Documentation

- [ ] Templ syntax guide in README
- [ ] Component composition patterns documented
- [ ] Editor setup instructions provided
- [ ] Props pattern documented with examples

## Technical Notes

### Templ Syntax Basics

Templ uses Go-like syntax for HTML generation:

```templ
// Component definition
templ HomePage(title string, items []Item) {
    <div class="container">
        <h1>{ title }</h1>

        // Control flow
        if len(items) > 0 {
            <ul>
                for _, item := range items {
                    <li>{ item.Name }</li>
                }
            </ul>
        } else {
            <p>No items found.</p>
        }
    </div>
}

// Invoking components
templ Page() {
    @Layout("My Page") {
        @HomePage("Welcome", items)
    }
}
```

**Key Syntax:**

- `{ expression }` - Interpolate Go expressions
- `@ComponentName()` - Invoke a component
- `{ children... }` - Render child content passed to component
- Standard Go control flow: `if`, `for`, `switch`
- Attributes: `<div class="{ className }" id={ elementID }>`

### Base Layout Pattern

```templ
// internal/http/views/layouts/base.templ
package layouts

templ Base(title string) {
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>{ title }</title>

        // Asset links (hashfs URLs in Epic 1.3)
        <link rel="stylesheet" href="/assets/app.css"/>
        <script src="/assets/app.js" defer></script>

        // HTMX (CDN initially, bundled in Epic 1.4)
        <script src="https://unpkg.com/htmx.org@2.0.4" defer></script>
    </head>
    <body>
        @components.Nav()

        <main>
            { children... }
        </main>

        @components.Footer()
    </body>
    </html>
}
```

### Component Props Pattern

Components use structs for props with validation:

```templ
// internal/http/views/components/card.templ
package components

type CardProps struct {
    Title       string
    Description string
    ImageURL    string
    Link        string
    LinkText    string
}

templ Card(props CardProps) {
    <div class="card">
        if props.ImageURL != "" {
            <img src={ props.ImageURL } alt={ props.Title }/>
        }

        <h3>{ props.Title }</h3>

        if props.Description != "" {
            <p>{ props.Description }</p>
        }

        if props.Link != "" {
            <a href={ templ.URL(props.Link) }>
                { props.LinkText }
            </a>
        }
    </div>
}
```

### Handler Integration

Handlers pass data to templates via props:

```go
// internal/http/handlers/home.go
package handlers

import (
    "net/http"
    "myapp/internal/http/views/pages"
)

func Home(w http.ResponseWriter, r *http.Request) {
    // Build page data
    data := pages.HomePageProps{
        Title: "Welcome to MyApp",
        FeaturedPosts: []Post{
            {Title: "Post 1", Slug: "post-1"},
            {Title: "Post 2", Slug: "post-2"},
        },
    }

    // Render template
    component := pages.HomePage(data)
    component.Render(r.Context(), w)
}
```

### Helper Functions

Common helpers for templates:

```go
// internal/http/views/helpers.go
package views

import (
    "strings"
    "time"
    "github.com/a-h/templ"
)

// ClassNames generates conditional CSS classes
func ClassNames(conditions map[string]bool) string {
    var classes []string
    for class, include := range conditions {
        if include {
            classes = append(classes, class)
        }
    }
    return strings.Join(classes, " ")
}

// FormatDate formats time for display
func FormatDate(t time.Time) string {
    return t.Format("January 2, 2006")
}

// FormatDateTime formats time with hours
func FormatDateTime(t time.Time) string {
    return t.Format("January 2, 2006 at 3:04 PM")
}
```

Usage in templates:

```templ
templ Button(label string, primary bool, disabled bool) {
    <button class={ helpers.ClassNames(map[string]bool{
        "btn": true,
        "btn-primary": primary,
        "btn-disabled": disabled,
    }) }>
        { label }
    </button>
}
```

### HTMX Attribute Helpers

Type-safe HTMX attributes:

```go
// internal/http/views/helpers.go

func HXGet(url string) templ.Attributes {
    return templ.Attributes{"hx-get": url}
}

func HXPost(url string) templ.Attributes {
    return templ.Attributes{"hx-post": url}
}

func HXTarget(selector string) templ.Attributes {
    return templ.Attributes{"hx-target": selector}
}

func HXSwap(strategy string) templ.Attributes {
    return templ.Attributes{"hx-swap": strategy}
}
```

Usage:

```templ
templ DeleteButton(postID string) {
    <button
        { helpers.HXPost("/delete-post")... }
        { helpers.HXTarget("#post-" + postID)... }
        { helpers.HXSwap("outerHTML")... }
        hx-confirm="Are you sure?"
    >
        Delete
    </button>
}
```

### Error Page Templates

```templ
// internal/http/views/pages/error.templ
package pages

type ErrorPageProps struct {
    Code    int
    Title   string
    Message string
    Details string
}

templ ErrorPage(props ErrorPageProps) {
    @layouts.Base(props.Title) {
        <div class="error-page">
            <h1>{ fmt.Sprintf("%d", props.Code) }</h1>
            <h2>{ props.Title }</h2>
            <p>{ props.Message }</p>

            if props.Details != "" {
                <details>
                    <summary>Technical Details</summary>
                    <pre>{ props.Details }</pre>
                </details>
            }

            <a href="/">Return Home</a>
        </div>
    }
}
```

### Form Component Example

```templ
// internal/http/views/components/form.templ
package components

type InputProps struct {
    Name        string
    Label       string
    Type        string
    Value       string
    Error       string
    Required    bool
    Placeholder string
}

templ Input(props InputProps) {
    <div class="form-group">
        <label for={ props.Name }>
            { props.Label }
            if props.Required {
                <span class="required">*</span>
            }
        </label>

        <input
            type={ props.Type }
            id={ props.Name }
            name={ props.Name }
            value={ props.Value }
            placeholder={ props.Placeholder }
            class={ helpers.ClassNames(map[string]bool{
                "form-input": true,
                "error": props.Error != "",
            }) }
            if props.Required {
                required
            }
        />

        if props.Error != "" {
            <p class="error-message">{ props.Error }</p>
        }
    </div>
}
```

### Partial Rendering for HTMX

```go
// Render component without layout for HTMX partial updates
func UpdateUserProfile(w http.ResponseWriter, r *http.Request) {
    user := getUserFromRequest(r)

    // Render just the component, not the full layout
    component := components.UserCard(user)
    component.Render(r.Context(), w)
}
```

### CSP-Compliant Templates

No inline scripts or styles:

```templ
// BAD: Inline script
<div onclick="alert('clicked')">Click me</div>

// GOOD: HTMX attribute or external script
<div hx-post="/api/click" hx-trigger="click">Click me</div>
```

## Testing Strategy

### Unit Tests

- Helper functions (ClassNames, FormatDate, etc.)
- Component rendering with various props
- Error handling in render functions

### Integration Tests

- Full page rendering through handlers
- Layout composition (base → nested layouts)
- HTMX partial responses
- Context data extraction

### Template Tests

```go
func TestHomePageRenders(t *testing.T) {
    props := pages.HomePageProps{
        Title: "Test Home",
        FeaturedPosts: []Post{},
    }

    var buf bytes.Buffer
    component := pages.HomePage(props)
    err := component.Render(context.Background(), &buf)

    require.NoError(t, err)
    assert.Contains(t, buf.String(), "Test Home")
}
```

## Next Epic

[Epic 1.3: HashFS Assets →](./1.3-hashfs-assets.md)

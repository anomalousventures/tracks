# Epic 1.6: Middleware Stack & Documentation

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.5](./1.5-templui-integration.md)

## Overview

Implement the core middleware stack for generated applications and create comprehensive documentation for Phase 1 features. This epic establishes essential middleware for request ID generation, logging, recovery, compression, security headers, and static file serving. It also creates detailed guides for router setup, template development, middleware configuration, asset management, and templ-ui customization.

## Goals

- Request ID generation middleware
- Structured logging middleware (zerolog)
- Panic recovery middleware
- Compression middleware (gzip)
- Security headers middleware
- Static file serving middleware
- CORS middleware (for API endpoints)
- Rate limiting middleware (basic)
- Middleware ordering documentation
- Complete router setup guide
- Template component guide
- Asset management guide
- Templ-UI customization guide
- Troubleshooting documentation

## Scope

### In Scope

- Request ID middleware (chi built-in)
- Logging middleware with zerolog
- Recovery middleware
- Compression middleware (chi built-in)
- Security headers (X-Content-Type-Options, X-Frame-Options, etc.)
- Static file serving
- CORS middleware
- Basic rate limiting
- Middleware order documentation
- Router setup documentation
- Template development documentation
- Asset pipeline documentation
- Component customization documentation
- Troubleshooting guides

### Out of Scope

- Authentication middleware (Phase 3)
- Authorization/RBAC middleware (Phase 3)
- CSRF protection (Phase 3)
- Session management (Phase 3)
- Advanced rate limiting (distributed, Redis-based)
- WAF-style request filtering (future)
- API versioning middleware (future)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Core Middleware (Tasks 1-15)

1. Create middleware package (internal/http/middleware/)
2. Implement RequestID middleware
3. Create logging middleware with zerolog
4. Implement recovery middleware
5. Add compression middleware
6. Create security headers middleware
7. Implement CORS middleware
8. Create rate limiting middleware (basic)
9. Add timeout middleware
10. Create real IP middleware
11. Implement content security policy (CSP) middleware
12. Add allowed hosts middleware
13. Create middleware chain builder
14. Test all middleware
15. Document middleware chain ordering

### Phase 2: Middleware Integration (Tasks 16-25)

1. Register middlewares in server.go
2. Create middleware configuration
3. Add middleware toggle flags
4. Implement middleware metrics
5. Create custom middleware example
6. Add middleware tests to generated projects
7. Create middleware troubleshooting guide
8. Document middleware best practices
9. Add middleware examples to README
10. Create middleware security checklist

### Phase 3: Router Documentation (Tasks 26-35)

1. Write router setup guide
2. Document route constants pattern
3. Create route organization guide
4. Document hypermedia routing patterns
5. Create route testing guide
6. Document graceful shutdown
7. Create HTTP configuration guide
8. Document health check endpoint
9. Create router troubleshooting guide
10. Write router best practices

### Phase 4: Template Documentation (Tasks 36-45)

1. Write template development guide
2. Document layout composition
3. Create component library guide
4. Document helper functions
5. Create form handling guide
6. Document error page templates
7. Write template testing guide
8. Create template performance guide
9. Document dark mode implementation
10. Write template best practices

### Phase 5: Asset & Build Documentation (Tasks 46-55)

1. Write asset pipeline guide
2. Document asset helper functions
3. Create TailwindCSS configuration guide
4. Document JavaScript bundling
5. Write Air configuration guide
6. Create Makefile reference
7. Document build modes
8. Write asset optimization guide
9. Create build troubleshooting guide
10. Document build best practices

### Phase 6: Comprehensive Documentation (Tasks 56-70)

1. Create quickstart guide
2. Write development workflow guide
3. Create deployment guide
4. Document project structure
5. Write configuration reference
6. Create templ-ui customization guide
7. Document CLI commands
8. Write testing guide
9. Create security guide
10. Document logging and monitoring
11. Write database integration guide (placeholder)
12. Create FAQ document
13. Write contributing guide for generated projects
14. Create example application
15. Write Phase 1 completion checklist

## Dependencies

### Prerequisites

- Phase 0 completed
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Epic 1.3 completed (HashFS assets)
- Epic 1.4 completed (Web build pipeline)
- Epic 1.5 completed (Templ-UI integration)

### External Dependencies

- `github.com/rs/zerolog` - Structured logging
- `github.com/go-chi/chi/v5/middleware` - Chi built-in middleware
- `github.com/go-chi/cors` - CORS middleware (optional)

## Acceptance Criteria

### Middleware Implementation

- [ ] Request ID middleware functional
- [ ] Logging middleware logs all requests
- [ ] Recovery middleware catches panics
- [ ] Compression middleware enabled
- [ ] Security headers set correctly
- [ ] CORS middleware configurable
- [ ] Rate limiting middleware working
- [ ] Middleware chain documented

### Documentation

- [ ] Router setup guide complete
- [ ] Template development guide complete
- [ ] Asset pipeline guide complete
- [ ] Middleware guide complete
- [ ] Templ-UI customization guide complete
- [ ] Build workflow documented
- [ ] Troubleshooting guides created
- [ ] Example application working

### Testing

- [ ] All middleware unit tests pass
- [ ] Integration tests verify middleware chain
- [ ] Documentation examples verified
- [ ] Example application builds and runs

## Next Steps

Phase 1 is complete! Next phase will add:

- Database integration (SQLC, migrations)
- Repository pattern
- Service layer
- Domain logic

See [Phase 2: Data Layer →](../../2-data-layer.md)

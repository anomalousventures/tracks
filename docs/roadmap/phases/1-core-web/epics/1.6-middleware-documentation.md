# Epic 1.6: Middleware Stack & Documentation

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.5](./1.5-templui-integration.md)

## Overview

Create templates and generator logic for core middleware stack and comprehensive documentation in generated projects. This epic implements template files for essential middleware (request ID, logging, recovery, compression, security headers), middleware configuration patterns, and complete documentation guides for router setup, template development, middleware configuration, asset management, and component customization. The ProjectGenerator will render these templates when running `tracks new`, creating production-ready middleware and documentation.

## Goals

- Templates for middleware package in generated projects
- Middleware templates (logging, recovery, security, CORS, rate limiting)
- Middleware configuration templates
- Documentation templates for all Phase 1 features
- Router setup guide templates
- Template development guide templates
- Asset pipeline guide templates
- Component customization guide templates
- Generated projects have working middleware and complete docs

## Scope

### In Scope

- Middleware package templates (internal/http/middleware/)
- Individual middleware templates (logging, recovery, security, CORS, etc.)
- Middleware configuration templates
- server.go middleware registration template updates
- Documentation templates (router, templates, assets, components)
- Troubleshooting guide templates
- Example application templates
- Quickstart guide templates
- ProjectGenerator integration
- Tests for middleware in generated projects

### Out of Scope

- Authentication middleware (Phase 3)
- Authorization/RBAC middleware (Phase 3)
- CSRF protection (Phase 3)
- Session management (Phase 3)
- Advanced rate limiting (distributed, Redis-based)
- WAF-style request filtering (future)
- API versioning middleware (future)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Middleware Templates (Tasks 1-20)

1. Create middleware package directory structure template
2. Create request_id.go middleware template
3. Create logger.go middleware template (zerolog)
4. Create recovery.go middleware template
5. Create compress.go middleware template
6. Create security_headers.go middleware template
7. Create cors.go middleware template
8. Create rate_limit.go middleware template (basic)
9. Create timeout.go middleware template
10. Create real_ip.go middleware template
11. Create middleware.go template (chain builder)
12. Create middleware config template
13. Create middleware_test.go templates
14. Add zerolog to go.mod template
15. Add CORS package to go.mod template (if needed)
16. Create middleware examples template
17. Create custom middleware example template
18. Document middleware ordering in comments
19. Create middleware troubleshooting guide template
20. Create middleware security checklist template

### Phase 2: Middleware Integration Templates (Tasks 21-30)

1. Update server.go template to register middlewares
2. Create middleware toggle configuration template
3. Update config.go template for middleware settings
4. Update .env.example template with middleware config
5. Create middleware metrics template
6. Wire middleware templates into ProjectGenerator
7. Create middleware registration tests template
8. Create middleware configuration tests template
9. Integration test: verify middleware chain in generated project
10. Integration test: verify security headers set correctly

### Phase 3: Documentation Templates (Tasks 31-50)

1. Create router setup guide template (docs/router.md)
2. Create template development guide template (docs/templates.md)
3. Create asset pipeline guide template (docs/assets.md)
4. Create middleware guide template (docs/middleware.md)
5. Create component customization guide template (docs/components.md)
6. Create quickstart guide template (docs/quickstart.md)
7. Create development workflow guide template (docs/development.md)
8. Create deployment guide template (docs/deployment.md)
9. Create testing guide template (docs/testing.md)
10. Create configuration reference template (docs/configuration.md)
11. Create project structure documentation template
12. Create troubleshooting guide template (docs/troubleshooting.md)
13. Create FAQ template (docs/faq.md)
14. Create contributing guide template (CONTRIBUTING.md)
15. Update README template with complete project overview
16. Create CLI commands documentation template
17. Create security guide template (docs/security.md)
18. Create logging guide template (docs/logging.md)
19. Create database guide template placeholder (docs/database.md)
20. Create Phase 1 completion checklist template

### Phase 4: ProjectGenerator Integration (Tasks 51-60)

1. Wire middleware templates into ProjectGenerator
2. Wire documentation templates into ProjectGenerator
3. Create docs/ directory structure in ProjectGenerator
4. Update server.go template rendering for middleware
5. Update config templates for middleware settings
6. Render all documentation files in correct locations
7. Test middleware templates render correctly
8. Test documentation templates render correctly
9. Integration test: verify middleware works in generated project
10. Integration test: verify all docs render correctly

### Phase 5: Testing & Validation (Tasks 61-70)

1. Create middleware unit test templates
2. Create middleware integration test templates
3. Test request ID middleware in generated project
4. Test logging middleware in generated project
5. Test recovery middleware in generated project
6. Test security headers in generated project
7. Test CORS middleware in generated project
8. Test rate limiting in generated project
9. Verify all documentation accurate
10. Integration test: complete Phase 1 feature validation

## Dependencies

### Prerequisites

- Phase 0 completed
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Epic 1.3 Asset Pipeline completed (all phases - TailwindCSS, HTMX v2, hashfs, caching, Air live reload)
- Epic 1.5 completed (Templ-UI integration)

### External Dependencies

- `github.com/rs/zerolog` - Structured logging (added to generated go.mod)
- `github.com/go-chi/chi/v5/middleware` - Chi built-in middleware
- `github.com/go-chi/cors` - CORS middleware (optional, added if needed)

## Acceptance Criteria

### Templates Created

- [ ] Middleware package template exists (internal/http/middleware/)
- [ ] Individual middleware templates exist (logging, recovery, security, etc.)
- [ ] Middleware configuration templates exist
- [ ] server.go template updated for middleware registration
- [ ] Documentation templates exist (router, templates, assets, middleware, components)
- [ ] Quickstart guide template exists
- [ ] Troubleshooting guide templates exist
- [ ] All templates use Go template syntax correctly

### Generator Integration

- [ ] ProjectGenerator creates middleware/ directory structure
- [ ] ProjectGenerator renders all middleware templates
- [ ] ProjectGenerator renders documentation templates
- [ ] ProjectGenerator creates docs/ directory structure
- [ ] Zerolog dependency appears in generated go.mod
- [ ] Middleware config appears in generated .env.example
- [ ] server.go registers middleware chain correctly

### Generated Code Quality

- [ ] Generated request ID middleware works
- [ ] Generated logging middleware logs requests
- [ ] Generated recovery middleware catches panics
- [ ] Generated security headers set correctly
- [ ] Generated CORS middleware configurable
- [ ] Generated rate limiting works
- [ ] Generated middleware tests pass
- [ ] Generated code passes `go vet` and `golangci-lint`

### Documentation Quality

- [ ] Generated router setup guide accurate
- [ ] Generated template development guide accurate
- [ ] Generated asset pipeline guide accurate
- [ ] Generated middleware guide accurate
- [ ] Generated component customization guide accurate
- [ ] Generated quickstart guide works
- [ ] Generated troubleshooting guides helpful
- [ ] All generated documentation renders correctly

### Testing

- [ ] Unit tests verify template rendering
- [ ] Integration tests verify middleware works in generated projects
- [ ] Integration tests verify documentation accurate
- [ ] All tests pass in CI

## Next Steps

Phase 1 is complete! Next phase will add:

- Database integration (SQLC, migrations)
- Repository pattern
- Service layer
- Domain logic

See [Phase 2: Data Layer →](../../2-data-layer.md)

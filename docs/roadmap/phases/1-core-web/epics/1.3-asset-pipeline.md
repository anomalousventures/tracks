# Epic 1.3: Asset Build & Serving Pipeline

[← Back to Phase 1](../1-core-web.md) | [← Epic 1.2](./1.2-templ-templates.md) | [Epic 1.4 (deprecated - merged here) →](./1.4-web-build-pipeline-deprecated.md)

> **Note:** This epic merges the original Epic 1.3 (HashFS Assets) and Epic 1.4 (Web Build Pipeline) into a single cohesive asset pipeline. The separate epics created artificial boundaries that complicated the build and serving flow. This unified approach delivers a complete, production-ready asset pipeline incrementally.

## Overview

Create templates and generator logic for a complete asset build and serving pipeline in generated projects. This epic delivers TailwindCSS compilation, HTMX v2 bundling with extensions, content-addressed serving via hashfs, and production-ready caching with ETag support. The pipeline builds assets at build time and serves them optimally at runtime.

## Goals

- Complete asset build pipeline (TailwindCSS, HTMX v2 + extensions)
- Content-addressed asset serving with hashfs
- Cache headers and ETag middleware for production performance
- Development workflow with Air live reload
- Production-optimized builds with minification
- Type-safe asset helpers for templ templates
- Counter component as working HTMX example

## Design Principles

### Build vs Serve Separation

- **Build Time:** `make assets` compiles TailwindCSS and bundles JavaScript
- **Compile Time:** `go build` embeds built assets via `//go:embed`
- **Run Time:** hashfs serves embedded assets with cache headers

### Simplicity Over Complexity

- **Always minify** - No dev/prod build modes (modern tools are fast enough)
- **Single build path** - What you dev is what you deploy
- **No sourcemaps** - Minimal JS usage doesn't require debugging
- **Single dependency** - `make build` builds everything

### Production Ready

- **Immutable caching** - 1-year cache for hashed assets
- **ETag support** - 304 Not Modified responses
- **Compression** - Gzip for text assets
- **Embedded assets** - Single binary deployment

## Scope

### In Scope

**Build Pipeline:**

- TailwindCSS compilation with minification
- JavaScript bundling with esbuild and minification
- HTMX v2 + extensions (`head-support`, `idiomorph`, `response-targets`)
- Makefile targets (`css`, `js`, `assets`, `build`, `dev`)
- Air live reload configuration
- package.json with all dependencies

**Asset Serving:**

- hashfs content-addressed URLs
- Asset embedding with `//go:embed`
- Static file handler
- Asset URL helpers for templ
- Cache-Control headers (1-year immutable for hashed assets)
- ETag middleware
- Compression middleware

**Development:**

- Air watches `.go`, `.templ`, `.css`, `.js`
- Live reload on changes
- `make dev` runs complete workflow
- Counter component example

**Testing:**

- Asset compilation tests
- hashfs serving tests
- Cache header tests
- Integration tests

### Out of Scope

- Separate dev/prod build modes (always minified)
- Sourcemap generation (minimal JS doesn't need it)
- Alpine.js (deferred; Templ-UI provides interactivity)
- TypeScript compilation (future)
- Sass/SCSS preprocessing (Tailwind handles everything)
- CSS modules
- Advanced PostCSS plugins
- Image optimization (future epic)
- Service workers / PWA (future)
- CDN integration (future)

## Task Breakdown

The following tasks will become GitHub issues, ordered by dependency:

### Phase 1: Basic Asset Infrastructure (5 tasks)

**Goal:** Get static file serving working with basic directory structure

1. [#386](https://github.com/anomalousventures/tracks/issues/386) Create internal/assets/ directory structure template
   - `internal/assets/web/css/`, `internal/assets/web/js/`, `internal/assets/web/images/`
   - `internal/assets/dist/` for built assets (gitignored)
   - `.gitkeep` files for empty directories
   - Basic placeholder files (empty app.css, app.js)

2. [#387](https://github.com/anomalousventures/tracks/issues/387) Create basic assets.go template
   - Simple `embed.FS` without hashfs initially
   - Basic file server handler
   - Serve from `/assets/*` route

3. [#389](https://github.com/anomalousventures/tracks/issues/389) Create static file handler template
   - Basic `http.FileServerFS` handler
   - Wire into routes.go
   - Test that static files are served

4. [#390](https://github.com/anomalousventures/tracks/issues/390) Add basic MIME type handling
   - Proper Content-Type headers
   - Support for common asset types (css, js, images, fonts)

5. [#391](https://github.com/anomalousventures/tracks/issues/391) Update .gitignore template
   - Ignore `node_modules/`
   - Ignore generated asset outputs (`internal/assets/dist/`)
   - Keep source assets (`internal/assets/web/`)

**Deliverable:** Static files served from `/assets/`, basic infrastructure in place

---

### Phase 2: Build Pipeline Setup (8 tasks)

**Goal:** Add TailwindCSS and JavaScript bundling (always minified)

1. [#396](https://github.com/anomalousventures/tracks/issues/396) Create package.json template
   - Dependencies: tailwindcss, esbuild
   - Basic build scripts
   - No HTMX yet (added in Phase 3)

2. [#397](https://github.com/anomalousventures/tracks/issues/397) Create tailwind.config.js template
   - Scan `.templ` files for classes
   - Content paths: `["internal/http/views/**/*.templ"]`
   - Basic theme configuration

3. [#398](https://github.com/anomalousventures/tracks/issues/398) Create internal/assets/web/css/app.css template
   - Tailwind directives (`@tailwind base; @tailwind components; @tailwind utilities;`)
   - Basic custom CSS layer for components
   - Dark mode CSS variables

4. [#399](https://github.com/anomalousventures/tracks/issues/399) Create Makefile css target template
   - `make css` compiles Tailwind with `--minify`
   - Output to `internal/assets/dist/app.css`
   - Always optimized

5. [#400](https://github.com/anomalousventures/tracks/issues/400) Create internal/assets/web/js/app.js template
   - Basic JavaScript entry point
   - Custom event handlers placeholder
   - No HTMX yet (bundled in Phase 3)

6. [#401](https://github.com/anomalousventures/tracks/issues/401) Create Makefile js target template
   - `make js` bundles JavaScript with esbuild `--minify`
   - Output to `internal/assets/dist/app.js`
   - Always optimized

7. [#402](https://github.com/anomalousventures/tracks/issues/402) Create Makefile assets target template
   - `make assets` runs both `css` and `js` targets
   - Simple sequential execution: `css` then `js`

8. [#403](https://github.com/anomalousventures/tracks/issues/403) Update Makefile build target template
   - `make build` depends on `generate` and `assets`
   - Ensures assets compiled before Go embeds them
   - Single command for complete build

**Deliverable:** `make assets` compiles CSS and JS (minified), served via basic file server

---

### Phase 3: Add HTMX v2 + Extensions (7 tasks)

**Goal:** Bundle HTMX and extensions into the JavaScript pipeline

1. [#404](https://github.com/anomalousventures/tracks/issues/404) Update package.json template with HTMX dependencies
   - Add `htmx.org` (HTMX v2)
   - Add `@htmx/ext-head-support`
   - Add `@htmx/ext-morph` (idiomorph)
   - Add `@htmx/ext-response-targets`

2. [#405](https://github.com/anomalousventures/tracks/issues/405) Update internal/assets/web/js/app.js to bundle HTMX
   - Import and initialize HTMX v2
   - Import and activate extensions
   - Bundle into single `htmx.min.js` output

3. [#406](https://github.com/anomalousventures/tracks/issues/406) Update Makefile js target for HTMX bundling
   - Modify esbuild config to create `htmx.min.js` output
   - Keep separate from `app.js` for clarity

4. [#407](https://github.com/anomalousventures/tracks/issues/407) Create HTMXConfig component template
   - Meta tag with HTMX configuration JSON
   - CSP nonce support
   - Extension-specific settings

5. [#408](https://github.com/anomalousventures/tracks/issues/408) Update base layout template to load HTMX
   - Load `/assets/htmx.min.js` with nonce
   - Add HTMXConfig component
   - Add `hx-boost="true"` to body for progressive enhancement

6. [#409](https://github.com/anomalousventures/tracks/issues/409) Create counter component template (HTMX example)
   - Handler with partial rendering
   - Template component showing HTMX patterns
   - Routes for counter increment/decrement

7. [#410](https://github.com/anomalousventures/tracks/issues/410) Integrate counter component into homepage template
   - Add counter to homepage
   - Demonstrates HTMX partial updates
   - Working example in generated project

**Deliverable:** HTMX v2 + extensions bundled and working, counter example functional

---

### Phase 4: Content-Addressed Serving (6 tasks)

**Goal:** Add cache busting via content-addressed URLs (hashfs)

1. [#411](https://github.com/anomalousventures/tracks/issues/411) Add hashfs dependency to go.mod template
   - `github.com/benbjohnson/hashfs`

2. [#412](https://github.com/anomalousventures/tracks/issues/412) Update assets.go template with hashfs
   - Replace basic embed.FS with `hashfs.NewFS()`
   - `HashName()` helper function
   - File server using hashfs

3. [#413](https://github.com/anomalousventures/tracks/issues/413) Create AssetURL helper function template
   - Takes logical path, returns hashed URL
   - Used by template helpers: `/assets/app.css` → `/assets/app.abc123.css`

4. [#414](https://github.com/anomalousventures/tracks/issues/414) Create asset helper component templates
   - `CSS(path)` helper for stylesheets
   - `JS(path, nonce)` helper for scripts
   - `Image(path, alt)` helper for images
   - `Favicon()` helper

5. [#415](https://github.com/anomalousventures/tracks/issues/415) Update base layout template to use asset helpers
   - Replace hardcoded paths with `@components.CSS("app.css")`
   - Use `@components.JS("htmx.min.js", nonce)`
   - Use `@components.Favicon()`

6. [#416](https://github.com/anomalousventures/tracks/issues/416) Create asset helper tests template
   - Test `HashName()` returns correct format (`file.ext` → `file.{hash}.ext`)
   - Test helpers generate correct HTML
   - Verify hashed URLs work

**Deliverable:** Assets served with content-addressed URLs (cache busting works)

---

### Phase 5: Production Optimization (4 tasks)

**Goal:** Add compression middleware (builds already minified)

1. [#417](https://github.com/anomalousventures/tracks/issues/417) Create compression middleware template
   - Gzip compression for text assets (HTML, CSS, JS, JSON)
   - Uses chi's compression middleware
   - Configurable compression level

2. [#418](https://github.com/anomalousventures/tracks/issues/418) Wire compression middleware into routes.go template
   - Add to middleware chain
   - Only compress compressible types
   - Proper ordering (before static file handler)

3. [#419](https://github.com/anomalousventures/tracks/issues/419) Update .air.toml template
   - Exclude generated outputs (`*_templ.go`, `internal/assets/dist/`)
   - Watch `.go`, `.templ`, `.css`, `.js` files
   - Build command runs `make build`

4. [#420](https://github.com/anomalousventures/tracks/issues/420) Create Makefile dev target template
   - `make dev` runs Air
   - Watches files and rebuilds
   - LiveReload integration

**Deliverable:** Compressed assets, Air live reload working

---

### Phase 6: Caching Strategy (6 tasks)

**Goal:** Production-ready HTTP caching with ETag support

1. [#421](https://github.com/anomalousventures/tracks/issues/421) Create cache header middleware template
   - Immutable cache for hashed assets (1 year)
   - `Cache-Control: public, max-age=31536000, immutable`
   - No caching for non-hashed assets

2. [#422](https://github.com/anomalousventures/tracks/issues/422) Create ETag middleware template
   - Generate ETags based on content hash
   - Support `If-None-Match` header
   - Return `304 Not Modified` when appropriate

3. [#423](https://github.com/anomalousventures/tracks/issues/423) Wire caching middleware into routes.go template
   - Apply to `/assets/*` routes
   - Proper middleware ordering (ETag before compression)

4. [#424](https://github.com/anomalousventures/tracks/issues/424) Create CORS headers template for fonts
   - Allow cross-origin font loading
   - Proper `Access-Control` headers

5. [#425](https://github.com/anomalousventures/tracks/issues/425) Create 404 handler template for missing assets
   - Log missing asset requests
   - Return proper 404 status
   - Helpful error messages in dev

6. [#426](https://github.com/anomalousventures/tracks/issues/426) Create cache header tests template
   - Verify `Cache-Control` headers set correctly
   - Test ETag generation
   - Test 304 responses

**Deliverable:** Production-ready caching with ETag support, optimal browser caching

---

### Phase 7: Development Workflow (6 tasks)

**Goal:** Complete Air configuration for smooth development

1. [#427](https://github.com/anomalousventures/tracks/issues/427) Create Makefile watch-css target template (optional)
   - Watch CSS files independently
   - Faster CSS-only rebuilds
   - Optional parallel workflow

2. [#428](https://github.com/anomalousventures/tracks/issues/428) Create Makefile watch-js target template (optional)
   - Watch JS files independently
   - Faster JS-only rebuilds
   - Optional parallel workflow

3. [#429](https://github.com/anomalousventures/tracks/issues/429) Update generated README with Air workflow
   - How to start dev server (`make dev`)
   - What triggers rebuilds
   - Troubleshooting common issues

4. [#430](https://github.com/anomalousventures/tracks/issues/430) Update generated README with build commands
   - `make assets` - Compile CSS and JS
   - `make build` - Build complete binary
   - `make dev` - Run with live reload

5. [#431](https://github.com/anomalousventures/tracks/issues/431) Update generated README with asset documentation
   - How to add CSS (edit `internal/assets/web/css/app.css`)
   - How to add JS (edit `internal/assets/web/js/app.js`)
   - How to use asset helpers in templates

6. [#432](https://github.com/anomalousventures/tracks/issues/432) Test Air workflow in integration tests
   - Start `make dev`
   - Verify server starts
   - Test live reload works

**Deliverable:** `make dev` runs Air, auto-rebuilds on file changes, instant feedback

---

### Phase 8: ProjectGenerator Integration (13 tasks)

**Goal:** Wire all templates into code generation

1. [#433](https://github.com/anomalousventures/tracks/issues/433) Wire internal/assets/ directory structure creation into ProjectGenerator
   - Create directories (`internal/assets/web/`, `internal/assets/dist/`)
   - Render `.gitkeep` files

2. [#434](https://github.com/anomalousventures/tracks/issues/434) Wire package.json template into ProjectGenerator
   - Render with correct dependencies

3. [#435](https://github.com/anomalousventures/tracks/issues/435) Wire build config templates into ProjectGenerator
   - Render `tailwind.config.js`
   - Render `postcss.config.js` (if needed)

4. [#436](https://github.com/anomalousventures/tracks/issues/436) Wire source asset templates into ProjectGenerator
   - Render `internal/assets/web/css/app.css`
   - Render `internal/assets/web/js/app.js`

5. [#437](https://github.com/anomalousventures/tracks/issues/437) Wire assets.go template into ProjectGenerator
   - Render with correct imports
   - Include hashfs initialization

6. [#438](https://github.com/anomalousventures/tracks/issues/438) Wire asset helper templates into ProjectGenerator
   - Render component files
   - Correct package imports

7. [#439](https://github.com/anomalousventures/tracks/issues/439) Wire middleware templates into ProjectGenerator
   - Render compression middleware
   - Render cache middleware
   - Render ETag middleware

8. [#440](https://github.com/anomalousventures/tracks/issues/440) Update Makefile template rendering for all asset targets
   - Include `css`, `js`, `assets`, `build`, `dev`
   - Include `watch-css`, `watch-js` (optional)
   - Proper dependencies between targets

9. [#441](https://github.com/anomalousventures/tracks/issues/441) Update routes.go template for asset serving
   - Register `/assets/*` route
   - Apply middleware chain (compression, cache, ETag)
   - Proper route ordering

10. [#442](https://github.com/anomalousventures/tracks/issues/442) Update base layout template rendering
    - Include all asset helpers
    - HTMXConfig component
    - Counter component integration

11. [#443](https://github.com/anomalousventures/tracks/issues/443) Wire counter component into ProjectGenerator
    - Render handler
    - Render template
    - Register routes

12. [#444](https://github.com/anomalousventures/tracks/issues/444) Update .gitignore template rendering
    - All asset-related ignores (`node_modules/`, `dist/`)

13. [#445](https://github.com/anomalousventures/tracks/issues/445) Update go.mod template for hashfs and Air
    - Add dependencies
    - Add tool directives

**Deliverable:** `tracks new` generates complete asset pipeline

---

### Phase 9: Testing & Validation (7 tasks)

**Goal:** Comprehensive tests for generated projects

1. [#446](https://github.com/anomalousventures/tracks/issues/446) Create asset compilation test template
   - Test `make css` compiles successfully
   - Test `make js` bundles successfully
   - Verify outputs exist

2. [#447](https://github.com/anomalousventures/tracks/issues/447) Create hashfs test template
   - Test `HashName()` generates correct format
   - Test hashed files accessible
   - Verify `embed.FS` works

3. [#448](https://github.com/anomalousventures/tracks/issues/448) Create cache header test template
   - Verify `Cache-Control` headers
   - Test ETag generation
   - Test 304 Not Modified responses

4. [#449](https://github.com/anomalousventures/tracks/issues/449) Create compression test template
   - Verify gzip compression works
   - Test content encoding headers
   - Check compressed response size

5. [#450](https://github.com/anomalousventures/tracks/issues/450) Create asset serving integration test template
   - Request assets via HTTP
   - Verify correct content returned
   - Test cache headers present

6. [#451](https://github.com/anomalousventures/tracks/issues/451) Integration test: Counter component works
   - Request homepage
   - Click counter increment
   - Verify HTMX partial update works

7. [#452](https://github.com/anomalousventures/tracks/issues/452) Integration test: HTMX extensions load correctly
   - Verify `head-support` active
   - Verify `idiomorph` active
   - Verify `response-targets` active

**Deliverable:** All tests pass, generated projects work correctly

---

## Dependencies

### Prerequisites

- Phase 0 completed (project generation working)
- Epic 1.1 completed (Chi router)
- Epic 1.2 completed (Templ templates)
- Go 1.25+ (tool directive, embed support)

### External Dependencies

**Go:**

- `github.com/benbjohnson/hashfs` - Content-addressed file system
- `github.com/go-chi/chi/v5/middleware` - Compression middleware
- `github.com/air-verse/air` - Live reload

**npm:**

- `tailwindcss` - CSS framework
- `esbuild` - JavaScript bundler
- `htmx.org` - HTMX v2
- `@htmx/ext-head-support` - Update document head during partial updates
- `@htmx/ext-morph` (idiomorph) - Intelligent DOM morphing
- `@htmx/ext-response-targets` - Target elements based on HTTP response

### Blocks

- Epic 1.5 (Templ-UI Integration) - needs asset pipeline and Tailwind

## Acceptance Criteria

### Build Pipeline

- [ ] `make css` compiles TailwindCSS with minification
- [ ] `make js` bundles JavaScript with HTMX v2 and extensions (minified)
- [ ] `make assets` builds all assets (css + js)
- [ ] `make build` builds assets and binary in correct order
- [ ] Builds are always minified (no dev/prod mode switching)

### Asset Serving

- [ ] Assets served from `/assets/*` with hashfs
- [ ] Content-addressed URLs work (`app.css` → `app.abc123.css`)
- [ ] Asset helpers generate correct hashed URLs
- [ ] Static file handler serves all asset types
- [ ] Assets embedded in binary via `//go:embed`

### Caching

- [ ] Hashed assets have 1-year cache headers with `immutable`
- [ ] ETag middleware generates correct ETags
- [ ] 304 Not Modified responses work
- [ ] Compression middleware gzips text assets

### HTMX Integration

- [ ] HTMX v2 bundled into `htmx.min.js`
- [ ] All three extensions bundled and active
- [ ] Counter component demonstrates partial rendering
- [ ] HTMXConfig component sets proper configuration

### Development Workflow

- [ ] Air configuration watches correct files
- [ ] `make dev` runs Air successfully
- [ ] File changes trigger rebuilds
- [ ] Browser LiveReload works

### Generated Code Quality

- [ ] All templates render without errors
- [ ] Generated code passes `go vet` and `golangci-lint`
- [ ] Generated asset tests pass
- [ ] Integration tests verify end-to-end functionality

### Testing

- [ ] Unit tests verify template rendering in tracks repo
- [ ] Generated project's tests pass (verified by e2e-workflow)
- [ ] Integration tests verify asset pipeline works
- [ ] All CI jobs pass

## Success Metrics

1. **`tracks new myapp`** generates a working project
2. **`cd myapp && make assets`** builds CSS and JS successfully
3. **`make build`** creates binary with embedded assets
4. **`./bin/myapp`** serves assets with cache headers
5. **`make dev`** runs with live reload
6. **Counter example works** on homepage with HTMX partial updates
7. **Asset caching verified** with 304 responses on repeat requests

## Migration from Epic 1.3 + 1.4

This epic replaces the original Epic 1.3 (HashFS Assets - 40 tasks) and Epic 1.4 (Web Build Pipeline - 35 tasks) with a unified approach (62 tasks). The merged epic:

- **Removes 13 tasks** of duplicated effort and unnecessary complexity
- **Eliminates dev/prod mode switching** (always minify)
- **Unifies build and serve** into one cohesive pipeline
- **Simplifies Makefile** (single build path)
- **Removes sourcemap generation** (minimal JS doesn't need it)

The result is a cleaner, simpler implementation that delivers the same functionality with less complexity.

## Next Epic

[Epic 1.5: Templ-UI Integration →](./1.5-templui-integration.md)

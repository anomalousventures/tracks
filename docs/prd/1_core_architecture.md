# Core Architecture

**[← Back to Summary](./0_summary.md)**

## Overview

Tracks operates as a command-line tool that generates and manages Go web applications. The CLI itself is built with Cobra and includes a TUI mode using Bubble Tea that launches by default. This document covers the structure of both the Tracks CLI tool and the applications it generates.

## Installation Requirements

### System Requirements

- Go 1.23 or later
- Git (for version control)
- Make (optional but recommended)
- Air (for hot-reload in development)

### Database Driver Requirements

**For go-libsql (default):**

```bash
# Requires CGO
export CGO_ENABLED=1

# macOS: Install build tools
xcode-select --install

# Linux: Install gcc
sudo apt-get install build-essential  # Debian/Ubuntu
sudo yum groupinstall "Development Tools"  # RHEL/CentOS
```

**For sqlite3:**

```bash
# Also requires CGO
export CGO_ENABLED=1
# Same build tools as above
```

**For PostgreSQL:**

```bash
# No CGO required
export CGO_ENABLED=0
# Just need PostgreSQL client libraries for development
```

## CLI Tool Structure

The Tracks CLI is the primary interface for creating and managing applications:

```go
// CLI command structure
type TracksCmd struct {
    *cobra.Command
    config  *Config
    logger  *zerolog.Logger
    spinner *pterm.SpinnerPrinter
}
```

### Command Reference

```bash
# Default behavior - launches interactive TUI
tracks

# Create a new application
tracks new <project>              # Interactive project creation
  --db go-libsql                  # Use Turso/LibSQL (default)
  --db sqlite3                    # Use traditional SQLite
  --db postgres                   # Use PostgreSQL
  --no-git                        # Skip git initialization
  --module github.com/user/app   # Custom module name

# Code generation
tracks generate <type> <name> [fields...]
  resource post title:string content:text author:relation
  handler webhook
  service notification
  repository comment
  migration add_published_to_posts

# Database operations
tracks db migrate                 # Run pending migrations
tracks db rollback [n]            # Rollback n migrations (default 1)
tracks db status                  # Show migration status
tracks db create <name>           # Create new migration
tracks db seed                    # Run seed files

# Development commands
tracks dev                        # Start dev server with hot-reload
  --port 8080                    # Custom port (default from config)
  --no-browser                   # Don't open browser automatically

tracks test                       # Run test suite
  --cover                        # Generate coverage report
  --integration                  # Include integration tests
  --e2e                          # Include E2E tests

# Production commands
tracks build                      # Build for production
  --target linux-amd64           # Cross-compile target
  --docker                       # Build Docker image
  --static                       # Static binary (CGO_ENABLED=0)

# MCP server
tracks mcp start                  # Start MCP server
  --stdio                        # Use stdio transport (default)
  --http --port 8090             # Use HTTP transport

# Utility commands
tracks version                    # Show version info
tracks doctor                    # Check system requirements
tracks update                    # Self-update to latest version
```

## Generated Application Structure

Applications generated by Tracks follow a consistent, idiomatic Go structure:

```text
myapp/
├── cmd/
│   ├── server/
│   │   └── main.go              # Application entrypoint
│   └── cli/
│       └── main.go              # App-specific CLI tools
│
├── internal/                    # Private application code
│   ├── config/
│   │   ├── config.go           # Configuration structs
│   │   ├── loader.go           # Viper configuration loader
│   │   └── validation.go       # Config validation rules
│   │
│   ├── handlers/               # HTTP request handlers
│   │   ├── base.go            # Base handler with common dependencies
│   │   ├── auth.go            # Authentication handlers
│   │   ├── health.go          # Health check endpoints
│   │   └── [resource].go      # Generated resource handlers
│   │
│   ├── services/               # Business logic layer
│   │   ├── auth.go            # Authentication service
│   │   ├── email.go           # Email service with adapters
│   │   ├── permission.go      # RBAC permission service
│   │   └── [resource].go      # Generated business logic
│   │
│   ├── repositories/           # Data access layer
│   │   ├── queries.go         # SQLC generated code
│   │   ├── interfaces.go      # Repository interfaces
│   │   └── [resource].go      # Resource-specific repos
│   │
│   ├── middleware/            # HTTP middleware
│   │   ├── auth.go           # Authentication checks
│   │   ├── security.go       # Security headers, CSP
│   │   ├── rate_limit.go     # Rate limiting
│   │   ├── session.go        # Session management
│   │   ├── i18n.go          # Internationalization
│   │   └── otel.go          # OpenTelemetry tracing
│   │
│   ├── templates/            # templ templates
│   │   ├── layouts/
│   │   │   ├── base.templ   # Main HTML layout
│   │   │   └── email.templ  # Email layout
│   │   ├── pages/
│   │   │   ├── home.templ   # Homepage
│   │   │   ├── login.templ  # Auth pages
│   │   │   └── [page].templ # Generated pages
│   │   ├── components/
│   │   │   ├── nav.templ    # Navigation
│   │   │   ├── forms.templ  # Form components
│   │   │   └── [comp].templ # Custom components
│   │   └── emails/
│   │       ├── welcome.templ # Welcome email
│   │       └── otp.templ     # OTP email
│   │
│   ├── assets/               # Static assets (embedded)
│   │   ├── css/
│   │   │   └── app.css      # Main stylesheet
│   │   ├── js/
│   │   │   └── app.js       # Alpine.js components
│   │   └── static/
│   │       ├── favicon.ico
│   │       └── robots.txt
│   │
│   ├── dto/                  # Data Transfer Objects
│   │   └── [resource]_dto.go # Request/response DTOs
│   │
│   ├── adapters/             # External service adapters
│   │   ├── email/
│   │   │   ├── ses.go       # AWS SES
│   │   │   └── mailpit.go   # Local development
│   │   ├── sms/
│   │   │   └── twilio.go
│   │   └── storage/
│   │       ├── s3.go
│   │       └── local.go
│   │
│   ├── pkg/                  # Internal packages
│   │   ├── slug/            # Slug generation
│   │   ├── validator/       # Custom validators
│   │   └── errors/         # Error types
│   │
│   └── rbac/                # Authorization
│       ├── model.conf       # Casbin model
│       └── policies.go      # Default policies
│
├── db/                       # Database files
│   ├── migrations/          # Goose migrations
│   │   ├── 20250116_init.sql
│   │   └── [timestamp]_[name].sql
│   ├── queries/             # SQLC queries
│   │   ├── users.sql
│   │   └── [resource].sql
│   └── seeds/               # Seed data
│       └── development.sql
│
├── tests/                    # Test files
│   ├── integration/         # Integration tests
│   ├── e2e/                # End-to-end tests
│   ├── fixtures/           # Test data
│   └── helpers/            # Test utilities
│
├── web/                     # Web assets (source)
│   ├── styles/             # Source CSS/SCSS
│   └── scripts/            # Source JavaScript
│
├── docs/                    # Documentation
│   ├── api/                # API documentation
│   └── deployment/         # Deployment guides
│
├── scripts/                 # Build & deployment scripts
│   ├── build.sh
│   └── docker-entrypoint.sh
│
├── .github/                 # GitHub configuration
│   └── workflows/
│       ├── ci.yml          # CI pipeline
│       └── release.yml     # Release automation
│
├── deployments/            # Deployment configs
│   ├── docker/
│   │   └── Dockerfile
│   ├── k8s/               # Kubernetes manifests
│   └── terraform/         # Infrastructure as code
│
├── .air.toml              # Air hot-reload config
├── .env.example           # Example environment variables
├── .gitignore            # Git ignore patterns
├── go.mod                # Go module definition
├── go.sum                # Go module checksums
├── Makefile              # Build automation
├── README.md             # Project documentation
├── sqlc.yaml             # SQLC configuration
├── tracks.yaml           # Tracks framework config
└── embed.go              # Asset embedding
```

## Directory Explanations

### `/cmd`

Contains application entry points. Each subdirectory is a separate executable.

### `/internal`

Private application code that cannot be imported by other projects. This is enforced by Go.

### `/internal/handlers`

HTTP handlers follow a pattern:

- Receive HTTP request
- Validate input
- Call service layer
- Render response (HTML via templ or JSON)

### `/internal/services`

Business logic that's independent of HTTP:

- Can be called from handlers, CLI, or background jobs
- Contains all business rules and workflows
- Uses repository interfaces for data access

### `/internal/repositories`

Data access layer:

- SQLC generates type-safe query functions
- Repository interfaces allow for testing with mocks
- No business logic, only data operations

### `/internal/middleware`

Composable middleware functions:

- Each middleware has a single responsibility
- Order matters (documented in server setup)
- Can short-circuit request processing

### `/internal/templates`

templ templates for HTML generation:

- Compiled to Go code for type safety
- Components are reusable across pages
- Layouts provide consistent structure

### `/db`

Database-related files:

- Migrations use timestamp prefixes for ordering
- Queries are written in SQL and processed by SQLC
- Seeds provide development/test data

## Architecture Principles

### 1. Layered Architecture

```text
HTTP Request → Handler → Service → Repository → Database
                ↓          ↓           ↓
            Validation  Business    Data Access
                        Logic
```

### 2. Dependency Injection

Services receive their dependencies through constructors:

```go
func NewUserService(repo UserRepository, email EmailSender) *UserService {
    return &UserService{
        repo:  repo,
        email: email,
    }
}
```

### 3. Interface-Based Design

Define interfaces for all external dependencies:

```go
type UserRepository interface {
    Create(ctx context.Context, user *User) error
    GetByID(ctx context.Context, id string) (*User, error)
}
```

### 4. Context Propagation

Always pass `context.Context` as the first parameter:

```go
func (s *Service) DoWork(ctx context.Context, input Input) (Output, error) {
    // Context carries deadlines, cancellation signals, and request-scoped values
}
```

### 5. Error Handling

Errors are values and should be handled explicitly:

```go
user, err := svc.GetUser(ctx, id)
if err != nil {
    if errors.Is(err, ErrNotFound) {
        // Handle not found
    }
    return fmt.Errorf("getting user: %w", err)
}
```

## Configuration Loading

The application uses a hierarchical configuration system:

1. **Default values** (in code)
2. **Configuration file** (tracks.yaml)
3. **Environment variables** (override everything)

```go
// internal/config/loader.go
func Load() (*Config, error) {
    v := viper.New()

    // Set defaults
    v.SetDefault("port", 8080)
    v.SetDefault("environment", "production")

    // Load from file
    v.SetConfigName("tracks")
    v.SetConfigType("yaml")
    v.AddConfigPath(".")

    // Override with env vars
    v.AutomaticEnv()
    v.SetEnvPrefix("APP")

    var cfg Config
    return &cfg, v.Unmarshal(&cfg)
}
```

## Build System

### Development Build

```bash
# Uses Air for hot-reload
make dev

# Or directly
air -c .air.toml
```

### Production Build

```bash
# Standard build
make build

# Cross-compilation
GOOS=linux GOARCH=amd64 make build

# Static binary (requires compatible database driver)
CGO_ENABLED=0 make build
```

### Docker Build

```dockerfile
# Multi-stage build for minimal image
FROM golang:1.23-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o server cmd/server/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /app/server /server
ENTRYPOINT ["/server"]
```

## Testing Strategy

### Unit Tests

```bash
# Run all unit tests
go test ./internal/...

# With coverage
go test -cover ./internal/...
```

### Integration Tests

```bash
# Run integration tests
go test ./tests/integration/...
```

### E2E Tests

```bash
# Using Hurl
hurl tests/e2e/*.hurl
```

## Next Steps

- Continue to [Database Layer →](./2_database_layer.md)
- Back to [Summary](./0_summary.md)

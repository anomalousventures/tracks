# Core Architecture

**[← Back to Summary](./0_summary.md)**

## Overview

Tracks operates as a command-line tool that generates and manages Go web applications. The CLI itself is built with Cobra and includes a TUI mode using Bubble Tea that launches by default. This document covers the structure of both the Tracks CLI tool and the applications it generates.

## Installation Requirements

### System Requirements

- Go 1.23 or later
- Git (for version control)
- Make (optional but recommended)
- Air (for hot-reload in development)

### Database Driver Requirements

**For go-libsql (default):**

```bash
# Requires CGO
export CGO_ENABLED=1

# macOS: Install build tools
xcode-select --install

# Linux: Install gcc
sudo apt-get install build-essential  # Debian/Ubuntu
sudo yum groupinstall "Development Tools"  # RHEL/CentOS
```

**For sqlite3:**

```bash
# Also requires CGO
export CGO_ENABLED=1
# Same build tools as above
```

**For PostgreSQL:**

```bash
# No CGO required
export CGO_ENABLED=0
# Just need PostgreSQL client libraries for development
```

## CLI Tool Structure

The Tracks CLI is the primary interface for creating and managing applications:

```go
// CLI command structure
type TracksCmd struct {
    *cobra.Command
    config  *Config
    logger  *zerolog.Logger
    spinner *pterm.SpinnerPrinter
}
```

### Command Reference

```bash
# Default behavior - launches interactive TUI
tracks

# Create a new application
tracks new <project>              # Interactive project creation
  --db go-libsql                  # Use Turso/LibSQL (default)
  --db sqlite3                    # Use traditional SQLite
  --db postgres                   # Use PostgreSQL
  --no-git                        # Skip git initialization
  --module github.com/user/app   # Custom module name

# Code generation
tracks generate <type> <name> [fields...]
  resource post title:string content:text author:relation
  handler webhook
  service notification
  repository comment
  migration add_published_to_posts

# Database operations
tracks db migrate                 # Run pending migrations
tracks db rollback [n]            # Rollback n migrations (default 1)
tracks db status                  # Show migration status
tracks db create <name>           # Create new migration
tracks db seed                    # Run seed files

# Development commands
tracks dev                        # Start dev server with hot-reload
  --port 8080                    # Custom port (default from config)
  --no-browser                   # Don't open browser automatically

tracks test                       # Run test suite
  --cover                        # Generate coverage report
  --integration                  # Include integration tests
  --e2e                          # Include E2E tests

# Production commands
tracks build                      # Build for production
  --target linux-amd64           # Cross-compile target
  --docker                       # Build Docker image
  --static                       # Static binary (CGO_ENABLED=0)

# MCP server
tracks mcp start                  # Start MCP server
  --stdio                        # Use stdio transport (default)
  --http --port 8090             # Use HTTP transport

# Utility commands
tracks version                    # Show version info
tracks doctor                    # Check system requirements
tracks update                    # Self-update to latest version
```

## Generated Application Structure

Applications generated by Tracks follow a consistent, idiomatic Go structure:

```text
myapp/
├── cmd/
│   ├── server/
│   │   └── main.go              # Application entrypoint
│   └── cli/
│       └── main.go              # App-specific CLI tools
│
├── internal/                    # Private application code
│   ├── config/
│   │   ├── config.go           # Configuration structs
│   │   ├── loader.go           # Viper configuration loader
│   │   └── validation.go       # Config validation rules
│   │
│   ├── http/                  # HTTP layer (server, routes, handlers, middleware, views)
│   │   ├── server.go          # HTTP server setup and dependency injection
│   │   ├── routes.go          # Route registration and middleware chain
│   │   ├── handlers/          # HTTP request handlers
│   │   │   ├── base.go        # Base handler with common dependencies
│   │   │   ├── auth.go        # Authentication handlers
│   │   │   ├── health.go      # Health check endpoints
│   │   │   └── [resource].go  # Generated resource handlers
│   │   ├── middleware/        # HTTP middleware
│   │   │   ├── auth.go        # Authentication checks
│   │   │   ├── security.go    # Security headers, CSP, nonce
│   │   │   ├── rate_limit.go  # Rate limiting
│   │   │   ├── session.go     # Session management
│   │   │   ├── i18n.go       # Internationalization
│   │   │   └── otel.go       # OpenTelemetry tracing
│   │   └── views/             # templ templates
│   │       ├── layouts/
│   │       │   ├── base.templ   # Main HTML layout
│   │       │   └── email.templ  # Email layout
│   │       ├── pages/
│   │       │   ├── home.templ   # Homepage
│   │       │   ├── login.templ  # Auth pages
│   │       │   └── [page].templ # Generated pages
│   │       ├── components/
│   │       │   ├── nav.templ    # Navigation
│   │       │   ├── forms.templ  # Form components
│   │       │   └── [comp].templ # Custom components
│   │       └── emails/
│   │           ├── welcome.templ # Welcome email
│   │           └── otp.templ     # OTP email
│   │
│   ├── interfaces/            # All service and repository interfaces (zero implementation)
│   │   ├── post.go           # PostService, PostRepository interfaces
│   │   ├── user.go           # UserService, UserRepository interfaces
│   │   └── auth.go           # AuthService interface
│   │
│   ├── domain/                # Business logic organized by feature
│   │   ├── posts/
│   │   │   ├── service.go    # Post service (implements interfaces.PostService)
│   │   │   ├── repository.go # Post repository (wraps db/generated, implements interfaces.PostRepository)
│   │   │   └── dto.go        # Post request/response DTOs
│   │   ├── users/
│   │   │   ├── service.go
│   │   │   ├── repository.go
│   │   │   └── dto.go
│   │   └── auth/
│   │       ├── service.go
│   │       ├── password.go   # Password authentication
│   │       ├── otp.go        # OTP authentication
│   │       └── errors.go     # Auth-specific errors
│   │
│   ├── assets/               # Compiled/embedded assets (built from web/)
│   │   ├── dist/
│   │   │   ├── app.css      # Built from web/styles/
│   │   │   └── app.js       # Built from web/scripts/
│   │   └── static/
│   │       ├── favicon.ico
│   │       └── robots.txt
│   │
│   ├── adapters/             # External service adapters
│   │   ├── email/
│   │   │   ├── ses.go       # AWS SES
│   │   │   └── mailpit.go   # Local development
│   │   ├── sms/
│   │   │   └── twilio.go
│   │   └── storage/
│   │       ├── s3.go
│   │       └── local.go
│   │
│   ├── pkg/                  # Internal packages
│   │   ├── slug/            # Slug generation
│   │   ├── validator/       # Custom validators
│   │   └── errors/         # Error types
│   │
│   └── rbac/                # Authorization
│       ├── model.conf       # Casbin model
│       └── policies.go      # Default policies
│
├── internal/db/             # Database files
│   ├── migrations/          # Goose migrations
│   │   ├── 20250116_init.sql
│   │   └── [timestamp]_[name].sql
│   ├── queries/             # SQLC query sources (hand-written SQL)
│   │   ├── users.sql
│   │   └── [resource].sql
│   ├── generated/           # SQLC-generated Go code (DO NOT EDIT)
│   │   ├── db.go
│   │   ├── models.go
│   │   └── queries.sql.go
│   └── seeds/               # Seed data
│       └── development.sql
│
├── tests/                    # Test files
│   ├── integration/         # Integration tests
│   ├── e2e/                # End-to-end tests
│   ├── fixtures/           # Test data
│   └── helpers/            # Test utilities
│
├── web/                     # Web asset sources (builds to internal/assets/dist/)
│   ├── styles/             # Source CSS/Tailwind
│   │   └── app.css
│   └── scripts/            # Source JavaScript/TypeScript
│       └── app.js
│
├── docs/                    # Documentation
│   ├── api/                # API documentation
│   └── deployment/         # Deployment guides
│
├── scripts/                 # Build & deployment scripts
│   ├── build.sh
│   └── docker-entrypoint.sh
│
├── .github/                 # GitHub configuration
│   └── workflows/
│       ├── ci.yml          # CI pipeline
│       └── release.yml     # Release automation
│
├── deployments/            # Deployment configs
│   ├── docker/
│   │   └── Dockerfile
│   ├── k8s/               # Kubernetes manifests
│   └── terraform/         # Infrastructure as code
│
├── .air.toml              # Air hot-reload config
├── .env.example           # Application runtime config template (copy to .env)
├── .gitignore            # Git ignore patterns
├── .tracks.yaml          # Tracks CLI project metadata (driver, module, resources)
├── go.mod                # Go module definition
├── go.sum                # Go module checksums
├── Makefile              # Build automation
├── README.md             # Project documentation
├── sqlc.yaml             # SQLC configuration
└── embed.go              # Asset embedding
```

## Directory Explanations

### `/cmd`

Contains application entry points. Each subdirectory is a separate executable.

### `/internal`

Private application code that cannot be imported by other projects. This is enforced by Go.

### `/internal/http`

The HTTP layer contains all web-facing code:

- **`server.go`** - HTTP server setup, dependency injection
- **`routes.go`** - Route registration, middleware chain configuration
- **`handlers/`** - HTTP request handlers (thin orchestration layer)
  - Receive HTTP request
  - Validate input using DTOs
  - Call domain services (via interfaces from multiple domains if needed)
  - Render response (HTML via templ or JSON)
  - Handlers orchestrate cross-domain operations
- **`middleware/`** - Composable middleware functions (single responsibility each)
- **`views/`** - templ templates for HTML generation

### `/internal/interfaces`

All service and repository interfaces - ZERO implementations:

- Prevents import cycles with mock generation
- Single source of truth for contracts
- Consumed by domain implementations and tests
- Each resource gets its own interface file (e.g., `post.go`, `user.go`)

### `/internal/domain`

Business logic organized by feature (modular architecture):

- Each feature in its own directory (`posts/`, `users/`, etc.)
- Service implementations (implements `interfaces.XxxService`)
- Repository implementations (wraps `db/generated` SQLC code, implements `interfaces.XxxRepository`)
- DTOs (request/response data transfer objects)
- Feature-specific business rules and validations
- Colocated: `domain/posts/service.go`, `domain/posts/repository.go`, and `domain/posts/dto.go`

### `/internal/db`

Database-related files:

- `db.go` - Connection setup and helper functions
- `migrations/` - Goose migration files (generated per resource)
- `queries/` - Hand-written SQL files (SQLC source)
- `generated/` - SQLC-generated Go code (**DO NOT EDIT** - regenerated by `sqlc generate`)

## Architecture Principles

### 1. Layered Architecture

```text
HTTP Request → Handler → Service → Repository → Database
                ↓          ↓           ↓
            Validation  Business    Data Access
                        Logic
```

### 2. Dependency Injection

Services receive their dependencies through constructors:

```go
func NewUserService(repo UserRepository, email EmailSender) *UserService {
    return &UserService{
        repo:  repo,
        email: email,
    }
}
```

### 3. Interface-Based Design

Define interfaces for all external dependencies:

```go
type UserRepository interface {
    Create(ctx context.Context, user *User) error
    GetByID(ctx context.Context, id string) (*User, error)
}
```

### 4. Context Propagation

Always pass `context.Context` as the first parameter:

```go
func (s *Service) DoWork(ctx context.Context, input Input) (Output, error) {
    // Context carries deadlines, cancellation signals, and request-scoped values
}
```

### 5. Error Handling

Errors are values and should be handled explicitly:

```go
user, err := svc.GetUser(ctx, id)
if err != nil {
    if errors.Is(err, ErrNotFound) {
        // Handle not found
    }
    return fmt.Errorf("getting user: %w", err)
}
```

### 6. Interface Location & Dependency Inversion

**Critical Pattern**: All service and repository interfaces are defined in `internal/interfaces/`, NOT in implementation packages. This prevents import cycles and enables mock generation with mockery.

**Why**: Defining interfaces alongside implementations creates circular dependencies when generating mocks. The `internal/interfaces` package has zero dependencies on other internal packages.

**Structure:**

```text
internal/interfaces/    # All interfaces (zero implementation)
internal/domain/        # Implementations (imports interfaces)
test/mocks/            # Generated from interfaces/ using mockery
```

**Example:**

```go
// internal/interfaces/post.go
package interfaces
type PostService interface { ... }
type PostRepository interface { ... }

// internal/domain/posts/service.go
package posts
import "myapp/internal/interfaces"
type service struct { repo interfaces.PostRepository }
func NewService(repo interfaces.PostRepository) interfaces.PostService { ... }

// test/mocks/post_service.go (generated)
package mocks
import "myapp/internal/interfaces"
type PostService struct { mock.Mock }
```

### 7. Incremental Code Generation

Tracks generates code incrementally using **marker comments** to safely update existing files:

**Markers in main.go:**

- `// TRACKS:DB:BEGIN` / `// TRACKS:DB:END` - Database setup
- `// TRACKS:REPOSITORIES:BEGIN` / `// TRACKS:REPOSITORIES:END` - Repository creation
- `// TRACKS:SERVICES:BEGIN` / `// TRACKS:SERVICES:END` - Service creation
- `// TRACKS:HANDLERS:BEGIN` / `// TRACKS:HANDLERS:END` - Handler creation
- `// TRACKS:ROUTES:BEGIN` / `// TRACKS:ROUTES:END` - Route registration

**Example:**

```go
// TRACKS:SERVICES:BEGIN
healthService := health.NewService()
postService := posts.NewService(postRepo)  // ← Added by tracks generate
// TRACKS:SERVICES:END
```

Tracks parses these markers and inserts new code BEFORE the END marker, preserving all custom code.

## Configuration Loading

The application uses a hierarchical configuration system for runtime settings:

1. **Default values** (in code via `viper.SetDefault()`)
2. **`.env` file** (development only, gitignored)
3. **Environment variables** (production, override everything)

**Note:** Applications do NOT read `.tracks.yaml` for runtime configuration. That file contains CLI project metadata only.

```go
// internal/config/loader.go
func Load() (*Config, error) {
    v := viper.New()

    // Set defaults
    v.SetDefault("server.port", ":8080")
    v.SetDefault("environment", "production")
    v.SetDefault("logging.level", "info")

    // Read from .env file (development only)
    v.SetConfigFile(".env")
    v.SetConfigType("env")
    _ = v.ReadInConfig() // Ignore error if file doesn't exist

    // Environment variables override everything (production)
    v.SetEnvPrefix("APP")
    v.AutomaticEnv()

    var cfg Config
    if err := v.Unmarshal(&cfg); err != nil {
        return nil, fmt.Errorf("failed to unmarshal config: %w", err)
    }

    return &cfg, nil
}
```

## Build System

### Development Build

```bash
# Uses Air for hot-reload
make dev

# Or directly
air -c .air.toml
```

### Production Build

```bash
# Standard build
make build

# Cross-compilation
GOOS=linux GOARCH=amd64 make build

# Static binary (requires compatible database driver)
CGO_ENABLED=0 make build
```

### Docker Build

```dockerfile
# Multi-stage build for minimal image
FROM golang:1.23-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o server cmd/server/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /app/server /server
ENTRYPOINT ["/server"]
```

## Testing Strategy

### Unit Tests

```bash
# Run all unit tests
go test ./internal/...

# With coverage
go test -cover ./internal/...
```

### Integration Tests

```bash
# Run integration tests
go test ./tests/integration/...
```

### E2E Tests

```bash
# Using Hurl
hurl tests/e2e/*.hurl
```

## Next Steps

- Continue to [Database Layer →](./2_database_layer.md)
- Back to [Summary](./0_summary.md)

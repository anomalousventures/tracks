# ADR-008: Generator Template Sequencing for Mock-Dependent Tests

**Status:** Accepted
**Date:** 2025-01-06
**Deciders:** Development Team
**Related:** [ADR-004: Mockery for Test Mock Generation](./004-mockery-for-test-mock-generation.md)

## Context

When generating projects, we faced a chicken-and-egg problem:

1. Test files import mocks from `tests/mocks` (e.g., `mocks.NewMockHealthService(t)`)
2. These mocks are generated by mockery from interfaces during `make generate`
3. But `go mod tidy` fails if test files exist with imports that don't resolve
4. And mockery can't run until dependencies are downloaded via `go mod tidy`

Initial attempts to solve this:

- **Running `go mod tidy` after writing all templates** - Failed because test files imported non-existent mocks
- **Running `make generate` in integration tests** - Failed because tools weren't downloaded yet
- **Using fake implementations instead of mocks** - Works but contradicts our decision in ADR-004 to use mockery-generated mocks

## Decision

**All code generators must sequence template rendering in two phases:**

### Phase 1: Application Templates

1. Render all non-test application files
   - Source code (handlers, services, repositories, etc.)
   - Configuration files (go.mod, Makefile, .golangci.yml, etc.)
   - Interface definitions (needed by mockery)
2. Run `go mod tidy` to resolve dependencies
3. Run `go mod download all` to download all dependencies including tools
4. Run `make generate` to create generated code:
   - Mocks via mockery (reads interfaces, writes `tests/mocks/*.go`)
   - SQL code via sqlc (reads queries, writes `internal/db/generated/*.go`)

### Phase 2: Test Templates

1. Render all test files
   - Unit tests (`*_test.go`)
   - Integration tests
   - Test helpers

This ensures test files can safely import generated code that now exists.

## Rationale

**Why this order?**

1. **Application files first** - Provides the interfaces mockery needs
2. **Tidy before download** - Ensures go.mod is consistent before downloading
3. **Download before generate** - Makes tools available via Go 1.25 tool directive
4. **Generate before tests** - Creates the code tests will import

**Why not alternatives?**

- **Build tags to skip tests during generation** - Adds complexity, doesn't solve the real problem
- **Fake implementations** - Violates ADR-004, prevents learning mockery patterns
- **Manual mock creation** - Defeats the purpose of code generation
- **Separate test generation command** - Poor UX, users expect working tests out-of-the-box

## Consequences

### Positive

- Generated projects have working tests immediately
- Tests demonstrate proper mock usage (educational value)
- No circular dependency issues during generation
- Pattern is repeatable for all future generators
- Aligns with ADR-004 (mockery-generated mocks)

### Negative

- Project generation takes slightly longer (~2-3 seconds for `make generate`)
- Generator implementation is more complex (split template maps)
- Must maintain awareness of which templates depend on generated code

### Implementation Guidance

When creating new generators (handlers, resources, repositories, etc.):

1. **Split templates into two maps:**

   ```go
   appTemplates := map[string]string{
       // Files that DON'T import generated code
       "internal/domain/user/service.go.tmpl": "internal/domain/user/service.go",
   }

   testTemplates := map[string]string{
       // Files that DO import generated code (mocks, sqlc)
       "internal/domain/user/service_test.go.tmpl": "internal/domain/user/service_test.go",
   }
   ```

2. **Follow the sequence:**

   ```go
   renderTemplates(appTemplates)
   runCommand("go", "mod", "tidy")
   runCommand("go", "mod", "download", "all")
   runCommand("make", "generate")
   renderTemplates(testTemplates)
   ```

3. **When in doubt, put templates in Phase 2 if they:**
   - Import `tests/mocks`
   - Import `internal/db/generated`
   - Import any other generated package

## References

- [ADR-004: Mockery for Test Mock Generation](./004-mockery-for-test-mock-generation.md)
- [Go 1.25 Tool Directive](https://go.dev/doc/toolchain)
- Initial implementation: PR #231 (project generator with test templates)

## Notes

This pattern will be critical for:

- Handler generators (tests import mocks)
- Repository generators (tests import mocks + sqlc)
- Resource generators (tests import mocks)
- Any generator that creates testable code

The sequencing overhead (~2-3s) is acceptable for the user experience gain of having working tests immediately.

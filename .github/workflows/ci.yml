name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# NOTE: Windows ARM (windows-11-arm) is temporarily disabled due to tooling limitations.
# The `go tool` pattern used for mockery and sqlc does not work correctly on ARM64 Windows,
# causing `make generate` failures in generated projects. We'll re-enable when Go 1.25+
# tooling has better ARM64 Windows support. The conditional race detector logic remains
# for future use when ARM is re-enabled.

jobs:
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest-large, macos-latest, windows-latest]
        go-version: ['1.25.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Set test flags
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-11-arm" ]]; then
            echo "TEST_FLAGS=-v -short -coverprofile=coverage-unit.out -p 1" >> $GITHUB_ENV
          else
            echo "TEST_FLAGS=-v -race -short -coverprofile=coverage-unit.out -p 1" >> $GITHUB_ENV
          fi

      - name: Run unit tests
        shell: bash
        run: go test $TEST_FLAGS ./...

      - name: Upload unit test coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage-unit.out
          flags: unittests-${{ runner.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest-large, macos-latest, windows-latest]
        go-version: ['1.25.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Set integration test timeouts
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            ubuntu-latest)
              echo "INTEGRATION_TEST_SHORT_TIMEOUT=2s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_MEDIUM_TIMEOUT=10s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_LONG_TIMEOUT=15s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_E2E_TIMEOUT=120s" >> $GITHUB_ENV
              ;;
            macos-latest|macos-latest-large)
              echo "INTEGRATION_TEST_SHORT_TIMEOUT=4s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_MEDIUM_TIMEOUT=20s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_LONG_TIMEOUT=30s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_E2E_TIMEOUT=180s" >> $GITHUB_ENV
              ;;
            windows-latest|windows-11-arm)
              echo "INTEGRATION_TEST_SHORT_TIMEOUT=6s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_MEDIUM_TIMEOUT=30s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_LONG_TIMEOUT=45s" >> $GITHUB_ENV
              echo "INTEGRATION_TEST_E2E_TIMEOUT=240s" >> $GITHUB_ENV
              ;;
          esac

      - name: Run integration tests
        shell: bash
        run: go test -v -coverprofile=coverage-integration.out -p 1 ./tests/integration

      - name: Upload integration test coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage-integration.out
          flags: integration-${{ runner.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  e2e-workflow:
    name: E2E Workflow (${{ matrix.driver }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        driver: [sqlite3, postgres, go-libsql]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Start Postgres
        if: matrix.driver == 'postgres'
        run: |
          docker run -d \
            --name postgres \
            -e POSTGRES_USER=testapp \
            -e POSTGRES_PASSWORD=testapp \
            -e POSTGRES_DB=testapp \
            -p 5432:5432 \
            --health-cmd="pg_isready -U testapp" \
            --health-interval=5s \
            --health-timeout=5s \
            --health-retries=5 \
            postgres:16-alpine

          until docker exec postgres pg_isready -U testapp; do
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Start LibSQL
        if: matrix.driver == 'go-libsql'
        run: |
          docker run -d \
            --name libsql \
            -p 8080:8080 \
            ghcr.io/tursodatabase/libsql-server:latest

          until curl -f http://localhost:8080/health; do
            echo "Waiting for libsql..."
            sleep 1
          done

      - name: Build tracks CLI
        run: make build

      - name: Generate project
        run: |
          ./bin/tracks new testapp \
            --db=${{ matrix.driver }} \
            --module=github.com/test/app

      - name: Run project tests
        run: |
          cd testapp
          make test

      - name: Set database URL
        run: |
          case "${{ matrix.driver }}" in
            sqlite3)
              echo "APP_DATABASE_URL=file:./data/test.db" >> $GITHUB_ENV
              ;;
            postgres)
              echo "APP_DATABASE_URL=postgres://testapp:testapp@localhost:5432/testapp?sslmode=disable" >> $GITHUB_ENV
              ;;
            go-libsql)
              echo "APP_DATABASE_URL=http://localhost:8080" >> $GITHUB_ENV
              ;;
          esac

      - name: Start dev server
        run: |
          cd testapp
          mkdir -p data
          APP_SERVER_PORT=:18080 make dev &
          sleep 3

      - name: Verify health endpoint
        run: |
          max_retries=30
          for i in $(seq 1 $max_retries); do
            if curl -f http://localhost:18080/api/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i/$max_retries failed, retrying..."
            sleep 1
          done
          echo "Health check failed after $max_retries attempts"
          exit 1

  docker-workflow:
    name: Docker Workflow (${{ matrix.driver }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        driver: [sqlite3, postgres, go-libsql]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: true

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download dependencies
        run: go mod download

      - name: Build tracks CLI
        run: make build

      - name: Generate project
        run: |
          ./bin/tracks new testapp \
            --db=${{ matrix.driver }} \
            --module=github.com/test/app

      - name: Build Docker image
        run: |
          cd testapp
          docker build -t testapp:test .

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: testapp:test
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Start database services
        if: matrix.driver != 'sqlite3'
        run: |
          cd testapp
          docker compose up -d --wait

      - name: Run container (sqlite3)
        if: matrix.driver == 'sqlite3'
        run: |
          docker run -d \
            --name testapp \
            -p 18080:8080 \
            -e APP_DATABASE_URL=file:/app/data/test.db \
            testapp:test

      - name: Run container (postgres)
        if: matrix.driver == 'postgres'
        run: |
          docker run -d \
            --name testapp \
            --network testapp_default \
            -p 18080:8080 \
            -e APP_DATABASE_URL=postgres://testapp:testapp@postgres:5432/testapp?sslmode=disable \
            testapp:test

      - name: Run container (go-libsql)
        if: matrix.driver == 'go-libsql'
        run: |
          docker run -d \
            --name testapp \
            --network testapp_default \
            -p 18080:8080 \
            -e APP_DATABASE_URL=http://libsql:8080 \
            testapp:test

      - name: Verify health endpoint
        run: |
          max_retries=30
          for i in $(seq 1 $max_retries); do
            if curl -f http://localhost:18080/api/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i/$max_retries failed, retrying..."
            sleep 1
          done
          echo "Health check failed after $max_retries attempts"
          docker logs testapp
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker stop testapp || true
          docker rm testapp || true
          cd testapp && docker compose down -v || true

  build-platforms:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest-large, macos-latest, windows-latest]
        go-version: ['1.25.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build binaries (Linux/macOS)
        if: runner.os != 'Windows'
        run: make build build-mcp

      - name: Build binaries (Windows)
        if: runner.os == 'Windows'
        run: |
          $VERSION = if ($v = git --no-pager describe --tags --always --dirty 2>$null) { $v } else { "dev" }
          $COMMIT = if ($c = git --no-pager rev-parse --short HEAD 2>$null) { $c } else { "none" }
          $DATE = if ($d = git --no-pager log -1 --format=%cI 2>$null) { $d } else { "unknown" }
          New-Item -ItemType Directory -Force -Path bin | Out-Null
          go build -ldflags="-X main.version=$VERSION -X main.commit=$COMMIT -X main.date=$DATE" -o bin/tracks.exe ./cmd/tracks
          go build -ldflags="-X main.version=$VERSION -X main.commit=$COMMIT -X main.date=$DATE" -o bin/tracks-mcp.exe ./cmd/tracks-mcp

      - name: Verify binaries (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          ./bin/tracks --version
          ./bin/tracks-mcp --version

      - name: Verify binaries (Windows)
        if: runner.os == 'Windows'
        run: |
          ./bin/tracks.exe --version
          ./bin/tracks-mcp.exe --version

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run golangci-lint
        run: make lint-go

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run markdown linter
        run: make lint-md

  javascript-lint:
    name: JavaScript Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: make lint-js

      - name: Check formatting
        run: make format-check

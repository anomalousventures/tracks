.PHONY: assets build clean css dev dev-down dev-services generate help js lint migrate-create migrate-down migrate-status migrate-up mocks sqlc templ test

{{- if eq .DBDriver "postgres"}}
MIGRATE_DIR := internal/db/migrations/postgres
{{- else}}
MIGRATE_DIR := internal/db/migrations/sqlite
{{- end}}

help: ## Show this help message
	@echo "Available targets:"
	@echo "  assets         - Build all assets (CSS and JS)"
	@echo "  build          - Build the server binary (includes assets)"
	@echo "  clean          - Remove build artifacts"
	@echo "  css            - Compile TailwindCSS"
	@echo "  dev            - Start development server (auto-starts services if needed)"
	@echo "  dev-down       - Stop docker-compose services"
	@echo "  dev-services   - Start docker-compose services"
	@echo "  generate       - Generate all code (templ, mocks, SQL)"
	@echo "  help           - Show this help message"
	@echo "  js             - Bundle JavaScript with esbuild"
	@echo "  lint           - Run linters"
	@echo "  migrate-create - Create new migration (usage: make migrate-create NAME=add_users)"
	@echo "  migrate-down   - Rollback last migration"
	@echo "  migrate-status - Show migration status"
	@echo "  migrate-up     - Apply all pending migrations"
	@echo "  mocks          - Generate mocks from interfaces"
	@echo "  sqlc           - Generate type-safe SQL code"
	@echo "  templ          - Generate templ templates"
	@echo "  test           - Run all tests"

assets: css js ## Build all assets (CSS and JS)

build: generate assets ## Build server binary (includes code generation and assets)
	@mkdir -p bin
	go build -o bin/server ./cmd/server

clean: ## Remove build artifacts
	rm -rf bin/ internal/assets/dist/

css: ## Compile TailwindCSS with minification
	@mkdir -p internal/assets/dist/css
	npx @tailwindcss/cli -i internal/assets/web/css/app.css -o internal/assets/dist/css/app.css --minify

dev: ## Start development server (auto-starts services if needed)
	@trap 'echo "Stopping services..."; docker-compose down' EXIT INT TERM; \
	if grep -q '^  [a-z]' docker-compose.yml 2>/dev/null; then \
		echo "Starting services..."; \
		docker-compose up -d; \
		sleep 2; \
	fi; \
	echo "Starting dev server..."; \
	go tool air -c .air.toml

dev-down: ## Stop docker-compose services
	docker-compose down

dev-services: ## Start docker-compose services
	docker-compose up -d

generate: templ mocks sqlc ## Generate all code (templ, mocks, SQL)

js: ## Bundle JavaScript with esbuild and minification
	@mkdir -p internal/assets/dist/js
	npx esbuild internal/assets/web/js/*.js --bundle --minify --outdir=internal/assets/dist/js/

lint: ## Run linters
	go tool golangci-lint run

mocks: ## Generate mocks from interfaces
	go tool mockery

sqlc: ## Generate type-safe SQL code
	go tool sqlc generate

migrate-create: ## Create new migration (usage: make migrate-create NAME=add_users)
	@if [ -z "$(NAME)" ]; then echo "Usage: make migrate-create NAME=migration_name"; exit 1; fi
	@timestamp=$$(date +%Y%m%d%H%M%S) && \
	echo "-- +goose Up\n-- +goose StatementBegin\n\n-- +goose StatementEnd\n\n-- +goose Down\n-- +goose StatementBegin\n\n-- +goose StatementEnd" > $(MIGRATE_DIR)/$${timestamp}_$(NAME).sql && \
	echo "Created: $(MIGRATE_DIR)/$${timestamp}_$(NAME).sql"

migrate-down: ## Rollback last migration
	go run ./cmd/migrate down

migrate-status: ## Show migration status
	go run ./cmd/migrate status

migrate-up: ## Apply all pending migrations
	go run ./cmd/migrate up

templ: ## Generate templ templates
	go tool templ generate

test: ## Run tests
	go test ./...

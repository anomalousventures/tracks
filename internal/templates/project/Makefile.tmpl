.PHONY: build clean dev dev-down dev-services generate help lint mocks sqlc templ test

help: ## Show this help message
	@echo "Available targets:"
	@echo "  build        - Build the server binary"
	@echo "  clean        - Remove build artifacts"
	@echo "  dev          - Start development server (auto-starts services if needed)"
	@echo "  dev-down     - Stop docker-compose services"
	@echo "  dev-services - Start docker-compose services"
	@echo "  generate     - Generate all code (templ, mocks, SQL)"
	@echo "  help         - Show this help message"
	@echo "  lint         - Run linters"
	@echo "  mocks        - Generate mocks from interfaces"
	@echo "  sqlc         - Generate type-safe SQL code"
	@echo "  templ        - Generate templ templates"
	@echo "  test         - Run all tests"

build: ## Build server binary
	@mkdir -p bin
	go build -o bin/server ./cmd/server

clean: ## Remove build artifacts
	rm -rf bin/

dev: ## Start development server (auto-starts services if needed)
	@trap 'echo "Stopping services..."; docker-compose down' EXIT INT TERM; \
	if grep -q '^  [a-z]' docker-compose.yml 2>/dev/null; then \
		echo "Starting services..."; \
		docker-compose up -d; \
		sleep 2; \
	fi; \
	echo "Starting dev server..."; \
	go tool air -c .air.toml

dev-down: ## Stop docker-compose services
	docker-compose down

dev-services: ## Start docker-compose services
	docker-compose up -d

generate: templ mocks sqlc ## Generate all code (templ, mocks, SQL)

lint: ## Run linters
	go tool golangci-lint run

mocks: ## Generate mocks from interfaces
	go tool mockery

sqlc: ## Generate type-safe SQL code
	go tool sqlc generate

templ: ## Generate templ templates
	go tool templ generate

test: ## Run tests
	go test ./...

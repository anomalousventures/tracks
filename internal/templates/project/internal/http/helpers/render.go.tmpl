package helpers

import (
	"net/http"

	"github.com/a-h/templ"
	"{{.ModuleName}}/internal/http/views/pages"
	"{{.ModuleName}}/internal/interfaces"
)

func IsHTMXRequest(r *http.Request) bool {
	return r.Header.Get("HX-Request") == "true"
}

func RenderPage(w http.ResponseWriter, r *http.Request, full templ.Component, partial templ.Component, logger interfaces.Logger) {
	ctx := r.Context()

	component := full
	if partial != nil && IsHTMXRequest(r) {
		component = partial
	}

	w.Header().Set("Content-Type", "text/html; charset=utf-8")

	if err := component.Render(ctx, w); err != nil {
		logger.Error(ctx).Err(err).Msg("failed to render template")
		RenderError(w, r, http.StatusInternalServerError, "Failed to render page", logger)
		return
	}
}

func RenderError(w http.ResponseWriter, r *http.Request, statusCode int, message string, logger interfaces.Logger) {
	ctx := r.Context()

	w.Header().Set("Content-Type", "text/html; charset=utf-8")
	w.WriteHeader(statusCode)

	if err := pages.ErrorPage(statusCode, message).Render(ctx, w); err != nil {
		logger.Error(ctx).Err(err).Msg("failed to render error template")
		http.Error(w, "Internal Server Error", http.StatusInternalServerError)
		return
	}
}

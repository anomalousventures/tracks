package routes

import (
	"fmt"
	"net/url"
)

// userSlug is the base path segment for user routes.
// Private to prevent external dependencies on this implementation detail.
const userSlug = "users"

// User route constants define HYPERMEDIA routes serving HTML via templ templates.
//
// PATTERN: HYPERMEDIA-First (Default)
// These routes serve HTML pages and include form routes (/new, /edit) following
// RESTful HTML conventions. This is the default pattern for all generated resources.
//
// Route Structure:
//   - UserIndex:  GET  /users              - List all users (HTML table/cards)
//   - UserShow:   GET  /users/:username    - Show single user (HTML profile)
//   - UserNew:    GET  /users/new          - Render user creation form (HTML form)
//   - UserCreate: POST /users              - Process form submission (redirect on success)
//   - UserEdit:   GET  /users/:username/edit - Render user edit form (HTML form)
//   - UserUpdate: PUT  /users/:username    - Process form submission (redirect on success)
//   - UserDelete: DELETE /users/:username  - Delete user (redirect on success)
//
// API Alternative (Future):
// For JSON APIs, use the --api flag with `tracks generate resource user --api`.
// This generates API routes with the /api prefix and no form routes:
//   - GET    /api/users              - List users (JSON array)
//   - GET    /api/users/:id          - Show user (JSON object)
//   - POST   /api/users              - Create user (JSON body, returns 201)
//   - PUT    /api/users/:id          - Update user (JSON body, returns 200)
//   - DELETE /api/users/:id          - Delete user (returns 204)
//
// Type-Safe URL Generation:
// Use the typed helper functions (UserShowURL, UserEditURL, etc.) instead of
// constructing URLs manually. This provides compile-time safety and proper URL encoding.
//
// Example Usage:
//   // GOOD: Type-safe, handles URL encoding
//   url := routes.UserShowURL("john.doe")
//   // Result: "/users/john.doe"
//
//   url := routes.UserEditURL("alice+bob@example")
//   // Result: "/users/alice%2Bbob%40example/edit"
//
//   // BAD: Error-prone, no encoding, no compile-time checks
//   url := "/users/" + username + "/edit"
const (
	UserIndex  = "/" + userSlug
	UserShow   = "/" + userSlug + "/:" + userSlug
	UserNew    = "/" + userSlug + "/new"
	UserCreate = "/" + userSlug
	UserEdit   = "/" + userSlug + "/:" + userSlug + "/edit"
	UserUpdate = "/" + userSlug + "/:" + userSlug
	UserDelete = "/" + userSlug + "/:" + userSlug
)

// RouteURL constructs a route URL with parameter substitution.
// It handles URL encoding for all parameter values to prevent injection attacks.
//
// Parameters:
//   - route: The route constant (e.g., UserShow, UserEdit)
//   - params: Key-value pairs for route parameters (e.g., "users", "john.doe")
//
// Example:
//   url := RouteURL(UserShow, "users", "john.doe")
//   // Result: "/users/john.doe"
//
// Note: This is a low-level helper. Prefer the typed helper functions below.
func RouteURL(route string, params ...string) string {
	if len(params) == 0 {
		return route
	}

	result := route
	for i := 0; i < len(params); i += 2 {
		if i+1 >= len(params) {
			break
		}
		key := params[i]
		value := params[i+1]
		placeholder := ":" + key
		result = replaceFirst(result, placeholder, url.PathEscape(value))
	}
	return result
}

// replaceFirst replaces the first occurrence of old with new in s.
func replaceFirst(s, old, new string) string {
	idx := 0
	for i := 0; i <= len(s)-len(old); i++ {
		if s[i:i+len(old)] == old {
			idx = i
			return s[:idx] + new + s[idx+len(old):]
		}
	}
	return s
}

// Typed helper functions for type-safe URL generation.
// These functions provide compile-time safety and proper URL encoding.
// Always prefer these over manual URL construction.

// UserIndexURL returns the URL for the user index page.
// Example: UserIndexURL() -> "/users"
func UserIndexURL() string {
	return UserIndex
}

// UserShowURL returns the URL for showing a specific user's profile.
// The username parameter is automatically URL-encoded.
// Example: UserShowURL("john.doe") -> "/users/john.doe"
func UserShowURL(username string) string {
	return RouteURL(UserShow, userSlug, username)
}

// UserNewURL returns the URL for the user creation form.
// Example: UserNewURL() -> "/users/new"
func UserNewURL() string {
	return UserNew
}

// UserCreateURL returns the URL for the user creation endpoint.
// This is typically used as a form action attribute.
// Example: UserCreateURL() -> "/users"
func UserCreateURL() string {
	return UserCreate
}

// UserEditURL returns the URL for editing a specific user.
// The username parameter is automatically URL-encoded.
// Example: UserEditURL("john.doe") -> "/users/john.doe/edit"
func UserEditURL(username string) string {
	return RouteURL(UserEdit, userSlug, username)
}

// UserUpdateURL returns the URL for updating a specific user.
// This is typically used as a form action attribute with method override.
// The username parameter is automatically URL-encoded.
// Example: UserUpdateURL("john.doe") -> "/users/john.doe"
func UserUpdateURL(username string) string {
	return RouteURL(UserUpdate, userSlug, username)
}

// UserDeleteURL returns the URL for deleting a specific user.
// This is typically used with DELETE method or method override.
// The username parameter is automatically URL-encoded.
// Example: UserDeleteURL("john.doe") -> "/users/john.doe"
func UserDeleteURL(username string) string {
	return RouteURL(UserDelete, userSlug, username)
}

# {{.ProjectName}}

Generated by [Tracks](https://github.com/anomalousventures/tracks)

## Server Architecture

This application follows a **HYPERMEDIA-first** approach, serving HTML via templ templates rather than JSON APIs. It uses a clean layered architecture (HTTP → Service → Repository → Database) with dependency injection for testability and implements graceful shutdown with proper signal handling.

For detailed architectural principles and patterns, see the [Tracks Architecture Guide](https://go-tracks.io/docs/guides/architecture-overview).

## Getting Started

### Prerequisites

- Go 1.25 or later
{{if eq .DBDriver "postgres"}}- PostgreSQL server
{{else}}{{if eq .DBDriver "go-libsql"}}- CGO enabled (for go-libsql driver)
- GCC (Linux) or Xcode (macOS) for compilation
- Compatible with Turso (libSQL cloud database)
{{else}}- CGO enabled (for sqlite3 driver)
- GCC (Linux) or Xcode (macOS) for compilation
{{end}}{{end}}

### Installation

```bash
# Generate all code (templ + mocks + SQLC)
make generate

# Run tests
make test

# Start development server
make dev
```

### Project Structure

- `cmd/server/` - Application entrypoint
- `internal/interfaces/` - Interface definitions (for mocking)
- `internal/domain/` - Business logic by feature
- `internal/infra/http/` - HTTP server and handlers
- `internal/routes/` - Route constants
- `db/` - Database migrations and queries
- `test/mocks/` - Generated mock implementations

### Development

This project uses:
- **Chi** - HTTP router
- **templ** - Type-safe HTML templates
- **SQLC** - Type-safe SQL queries
- **HTMX** - Progressive enhancement
- **Mockery** - Interface mocking

See [CONTRIBUTING.md](./CONTRIBUTING.md) for development guidelines.

### Routing Philosophy

This application follows a **HYPERMEDIA-first** approach by default:

- **HTML by default** - Routes serve HTML pages via templ templates, not JSON APIs
- **Progressive enhancement** - HTMX provides interactivity without sacrificing accessibility
- **API routes are rare exceptions** - Only for specific use cases like health checks, metrics, and webhooks
- **Domain-based organization** - Routes organized by domain in separate files under `internal/routes/`
- **Type-safe route constants** - All routes defined as constants with typed helper functions

For detailed routing patterns, URL generation, and the route constants pattern, see the [Tracks Routing Guide](https://go-tracks.io/docs/guides/routing-guide).

### Available Commands

```bash
make help      # Show all available commands
make test      # Run tests
make build     # Build the server binary
make dev       # Start development server with hot reload
make fmt       # Format code with gofmt
make lint      # Run all linters (golangci-lint + markdown)
make generate  # Generate all code (templ + mocks + SQLC)
make templ     # Generate Go code from templ templates
make mocks     # Generate mocks from interfaces
make sqlc      # Generate type-safe SQL code
```

## Database

{{- if eq .DBDriver "postgres"}}

This project uses **PostgreSQL** for data storage.
{{- else if eq .DBDriver "go-libsql"}}

This project uses **go-libsql** (Turso) for data storage.
{{- else}}

This project uses **SQLite3** for data storage.
{{- end}}

### Quick Start

```bash
# Apply migrations
make migrate-up

# Check migration status
tracks db status

# Create a new migration
goose -dir internal/db/migrations create add_users_table sql
```

### Schema Changes

1. Create migration: `goose -dir internal/db/migrations create <name> sql`
2. Write SQL in the generated file
3. Apply with `make migrate-up`
4. Regenerate SQLC: `make sqlc`

### Writing Queries

SQL queries live in `internal/db/queries/`. SQLC generates type-safe Go code from annotated SQL:

```sql
-- name: GetUser :one
SELECT * FROM users WHERE id = ? LIMIT 1;
```

See the [SQLC Queries Guide](https://go-tracks.io/docs/guides/sqlc-queries) for patterns.

### Database Commands

```bash
make migrate-up       # Apply pending migrations
make migrate-down     # Rollback last migration
make migrate-status   # Show migration status
tracks db migrate     # Apply via CLI
tracks db rollback    # Rollback via CLI
tracks db status      # Status via CLI
```

For setup details and troubleshooting, see the [Database Setup Guide](https://go-tracks.io/docs/guides/database-setup).

## Development Workflow

The `make dev` command uses [Air](https://github.com/air-verse/air) for live reload:

- **Auto-rebuild on file changes** - Watches `.go`, `.templ`, `.css`, `.js` files
- **Asset pipeline integration** - Rebuilds CSS/JS before Go compilation
- **Generated file exclusion** - Ignores `*_templ.go` and `internal/assets/dist/`

```bash
make dev    # Start development server with live reload
```

See the [Development Workflow Guide](https://go-tracks.io/docs/guides/development-workflow) for details.

## UI Components

This project uses [templUI](https://templui.io) for UI components.

### Adding Components

```bash
# Using tracks CLI
tracks ui add button card toast

# Or directly with templui
go tool templui add button card toast
```

### Available Components

```bash
tracks ui list
```

### Component Location

Components are installed in `internal/http/views/components/ui/`.

### Customization

templUI components are "copy-paste" - you own the code and can customize freely.

See [templUI documentation](https://templui.io) for component reference.

## Docker

### Building the Docker Image

```bash
docker build -t {{.ProjectName}}:latest .
```

### Running the Container

```bash
# Run with default settings (development/testing)
docker run -p 8080:8080 {{.ProjectName}}:latest

# Run with production database configuration
docker run -p 8080:8080 \
{{- if eq .DBDriver "postgres"}}
  -e APP_DATABASE_URL=postgres://user:pass@host:5432/dbname \
{{- else if eq .DBDriver "go-libsql"}}
  -e APP_DATABASE_URL=libsql://your-database.turso.io \
{{- else}}
  -e APP_DATABASE_URL=file:data/{{.ProjectName}}.db \
  -v $(pwd)/data:/app/data \
{{- end}}
  {{.ProjectName}}:latest
```

The health endpoint (`/api/health`) works with default settings for testing. Production deployments should configure `APP_DATABASE_URL` to connect to an actual database.

### Using Docker Compose

For local development with dependencies:

```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop all services
docker-compose down
```

## Configuration

This project uses separate configuration files for different purposes:

- **`.tracks.yaml`** - Tracks CLI project metadata (database driver, module path) - committed to git
- **`.env`** - Application runtime configuration (copy from `.env.example`) - NOT committed

For runtime configuration, copy `.env.example` to `.env` and customize:

```bash
cp .env.example .env
# Edit .env with your values
```

See `.env.example` for all available configuration options.

## Troubleshooting

Having routing issues or server problems? Check the [Tracks Troubleshooting Guide](https://go-tracks.io/docs/guides/troubleshooting-routing) for solutions to common issues:

- Route not found (404) debugging with `chi.Walk()`
- Middleware execution order and configuration
- URL parameter extraction problems
- Route conflicts and specificity
- CORS and preflight request issues
- Graceful shutdown problems

## Middleware

This application includes production-ready middleware for security and performance:

- **Request Logging** - Structured logging with request IDs for tracing
- **Compression** - Gzip response compression for text-based content
- **Timeout** - Cancels long-running requests (configurable, default 60s)
- **Throttling** - Limits concurrent requests to prevent overload (configurable, default 100)
- **Security Headers** - X-Frame-Options, X-Content-Type-Options, CSP, etc.
- **CORS** - Cross-origin request handling (disabled by default)

Configure middleware via environment variables in `.env`. See `.env.example` for all options and the [Tracks Middleware Guide](https://go-tracks.io/docs/guides/middleware) for detailed documentation.

## Asset Caching

This project uses content-addressed asset serving via hashfs:

- **Hashed assets** (e.g., `app.abc123.css`) get 1-year immutable cache headers
- **ETags** enable 304 Not Modified responses for unchanged assets
- **Compression** via gzip for text-based assets

See the [Tracks Asset Caching Guide](https://go-tracks.io/docs/guides/caching) for details.

## License

[Your license here]
